<!DOCTYPE html>
<html lang="id" class="transition-colors duration-300">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>AdsTor - Automate. Optimize. Scale.</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b', 900: '#0f172a', 950: '#020617' },
                        teal: { 50: '#f0fdfa', 100: '#ccfbf1', 500: '#14b8a6', 600: '#0d9488', 700: '#0f766e', 900: '#134e4a' }
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    },
                    fontFamily: {
                        sans: ['Inter', 'ui-sans-serif', 'system-ui', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        ::-webkit-scrollbar { width: 4px; height: 4px; background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .modal-enter { opacity: 0; transform: scale(0.95); }
        .modal-enter-active { opacity: 1; transform: scale(1); transition: opacity 0.3s ease-out, transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.03); }
        .dark .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.4); }
        input[type="radio"] { accent-color: #14b8a6; width: 1.2em; height: 1.2em; }
        input[type="checkbox"].day-check { accent-color: #14b8a6; width: 1.2em; height: 1.2em; }
        .calendar-day { @apply h-10 w-full flex items-center justify-center text-sm font-medium cursor-pointer transition text-slate-700 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-full relative select-none; }
        .calendar-day.range-start { @apply bg-teal-600 text-white rounded-l-full rounded-r-none hover:bg-teal-700 z-10; }
        .calendar-day.range-end { @apply bg-teal-600 text-white rounded-r-full rounded-l-none hover:bg-teal-700 z-10; }
        .calendar-day.in-range { @apply bg-teal-100 text-teal-800 dark:bg-teal-900/40 dark:text-teal-200 rounded-none; }
        .calendar-day.today::after { content: ''; @apply absolute bottom-1.5 w-1.5 h-1.5 bg-teal-500 rounded-full; }
        .rules-table th { @apply px-4 py-4 text-left text-[11px] font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider border-b border-slate-200 dark:border-slate-800 bg-slate-50 dark:bg-slate-900/50 whitespace-nowrap; }
        .rules-table td { @apply px-4 py-4 whitespace-nowrap text-sm text-slate-700 dark:text-slate-300 border-b border-slate-100 dark:border-slate-800/50 align-middle; }
        .swal2-popup { @apply rounded-3xl !important; font-family: 'Inter', sans-serif !important; }
        .dark .swal2-popup { @apply bg-slate-900 text-white border border-slate-700 !important; }
        .dark .swal2-title, .dark .swal2-content { @apply text-slate-100 !important; }
    </style>
</head>
<body class="bg-[#f8fafc] dark:bg-slate-950 text-slate-900 dark:text-slate-100 font-sans pb-32 transition-colors duration-300 selection:bg-teal-500 selection:text-white">

    <!-- Navbar -->
    <nav class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-md border-b border-slate-200 dark:border-slate-800 sticky top-0 z-40">
        <div class="max-w-md mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center shadow-lg shadow-blue-500/20 shrink-0">
                    <i class="fa-solid fa-layer-group text-white text-lg"></i>
                </div>
                <div class="flex flex-col justify-center">
                    <h1 class="font-black text-slate-900 dark:text-white tracking-tighter leading-none text-lg">AdsTor</h1>
                    <p class="text-[10px] font-medium text-slate-500 dark:text-slate-400 tracking-wide mt-0.5 hidden sm:block leading-none" id="appTagline">Automate. Optimize. Scale.</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="openAccountSelectModal()" class="flex items-center gap-2 bg-slate-50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 pl-3 pr-3 py-2 rounded-lg hover:border-blue-400 transition active:scale-95 group max-w-[140px]">
                    <span id="headerAccountLabel" class="text-[10px] font-bold text-slate-700 dark:text-slate-200 truncate">Demo Mode</span>
                    <i class="fa-solid fa-chevron-down text-[8px] text-slate-400 group-hover:text-blue-500"></i>
                </button>
                <button onclick="toggleTheme()" id="themeToggleBtn" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition active:scale-95 touch-manipulation"><i class="fa-solid fa-moon text-xs"></i></button>
                <button onclick="refreshData()" id="refreshBtn" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 dark:bg-slate-800 hover:bg-slate-100 dark:hover:bg-slate-700 text-slate-600 dark:text-slate-300 transition active:scale-95 touch-manipulation"><i class="fa-solid fa-arrows-rotate text-xs" id="refreshIcon"></i></button>
            </div>
        </div>
    </nav>

    <main class="max-w-md mx-auto px-4 py-6 space-y-8">
        <!-- Summary Section -->
        <div class="space-y-4">
            <div class="flex justify-between items-end">
                <div class="flex-1 min-w-0 pr-2">
                    <div class="flex items-center gap-2 mb-1">
                        <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight leading-tight">Ringkasan</h2>
                        <button onclick="openMetricConfigModal('summary')" class="w-6 h-6 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-400 hover:text-blue-500 flex items-center justify-center transition" title="Atur Metrik Ringkasan"><i class="fa-solid fa-sliders text-[10px]"></i></button>
                    </div>
                    <p class="text-sm text-slate-500 dark:text-slate-400 font-medium truncate" id="currentDateDisplay">Memuat tanggal...</p>
                </div>
                <button onclick="openDateRangeModal()" class="flex items-center gap-2 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 px-4 py-2.5 rounded-2xl text-xs font-bold text-slate-600 dark:text-slate-300 shadow-sm active:scale-95 transition hover:border-teal-500 dark:hover:border-teal-500 group"><i class="fa-solid fa-calendar-day text-teal-500 group-hover:scale-110 transition"></i><span id="activeDateLabel">7 Hari Terakhir</span></button>
            </div>
            <div id="summaryGrid" class="grid grid-cols-2 gap-4"><div class="col-span-2 text-center py-8 text-slate-400 animate-pulse text-sm">Memuat metrik...</div></div>
        </div>

        <!-- Campaign Performance -->
        <section class="space-y-5">
            <div class="flex items-center justify-between">
                <h3 class="font-bold text-xl text-slate-800 dark:text-white tracking-tight">Performa Kampanye</h3>
                <button onclick="openMetricConfigModal('campaign')" class="text-xs bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 px-4 py-2 rounded-full font-bold hover:bg-slate-200 dark:hover:bg-slate-700 transition active:scale-95"><i class="fa-solid fa-table-columns mr-1.5"></i> Atur Metrik</button>
            </div>
            <div id="campaignList" class="space-y-4 pb-4">
                <div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 card-shadow animate-pulse"><div class="h-5 bg-slate-200 dark:bg-slate-800 rounded w-3/4 mb-5"></div><div class="grid grid-cols-2 gap-3"><div class="h-12 bg-slate-100 dark:bg-slate-800 rounded-xl"></div><div class="h-12 bg-slate-100 dark:bg-slate-800 rounded-xl"></div></div></div>
            </div>
        </section>
    </main>

    <!-- Bottom Navigation -->
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-[340px] z-40">
        <div class="bg-slate-900/90 dark:bg-slate-800/90 backdrop-blur-xl text-white p-1.5 rounded-full flex justify-between items-center shadow-2xl border border-slate-700/50 ring-1 ring-white/10">
            <button class="flex-1 p-3.5 rounded-full text-blue-400 hover:bg-white/10 transition active:scale-90" title="Dashboard"><i class="fa-solid fa-chart-pie text-xl"></i></button>
            <button onclick="openRulesModal()" class="flex-1 p-3.5 rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition active:scale-90" title="Aturan Otomatis"><i class="fa-solid fa-robot text-xl"></i></button>
            <button onclick="openAccountModal()" class="flex-1 p-3.5 rounded-full text-slate-400 hover:text-white hover:bg-white/10 transition active:scale-90" title="Pengaturan"><i class="fa-solid fa-gear text-xl"></i></button>
        </div>
    </div>

    <!-- Modals -->

    <!-- MODAL: ACCOUNT SELECT -->
    <div id="accountSelectModal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeAccountSelectModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm max-h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="accountSelectModalContent">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-900 dark:text-white">Pilih Akun</h3>
                <button onclick="closeAccountSelectModal()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-0 overflow-y-auto flex-1"><div id="accountSelectionList" class="flex flex-col"></div></div>
            <div class="p-4 border-t border-slate-100 dark:border-slate-800">
                <button onclick="closeAccountSelectModal(); openAccountModal();" class="w-full py-3 rounded-xl border border-dashed border-slate-300 dark:border-slate-700 text-slate-500 dark:text-slate-400 font-bold text-sm hover:bg-slate-50 dark:hover:bg-slate-800 transition"><i class="fa-solid fa-plus mr-2"></i> Kelola / Tambah Akun</button>
            </div>
        </div>
    </div>

    <!-- MODAL: METRIC CONFIG -->
    <div id="metricConfigModal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeMetricConfigModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md max-h-[90vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="metricConfigModalContent">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div><h3 class="font-bold text-lg text-slate-900 dark:text-white" id="metricConfigTitle">Atur Metrik</h3><p class="text-xs text-slate-500 dark:text-slate-400" id="metricConfigSubtitle">...</p></div>
                <button onclick="closeMetricConfigModal()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <div class="flex justify-between items-center mb-2"><p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest">Metrik Aktif</p><button onclick="saveCurrentMetricConfig()" class="text-xs text-blue-600 dark:text-blue-400 font-bold hover:underline py-1 px-2">Simpan Perubahan</button></div>
                <div id="configActiveMetricsList" class="flex flex-wrap gap-2"></div>
                <div class="relative mt-4"><select id="configAvailableMetrics" class="w-full appearance-none pl-4 pr-10 py-3 border border-slate-200 dark:border-slate-700 rounded-xl text-sm bg-slate-50 dark:bg-slate-800 text-slate-700 dark:text-slate-200 h-12 outline-none focus:border-blue-500 transition"></select><button onclick="addMetricToConfig()" class="absolute right-1 top-1 bottom-1 px-4 bg-blue-600 text-white rounded-lg text-xs font-bold shadow-sm hover:bg-blue-700"><i class="fa-solid fa-plus"></i></button></div>
            </div>
        </div>
    </div>

    <!-- DATE MODAL -->
    <div id="dateRangeModal" class="fixed inset-0 z-[100] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeDateRangeModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:w-[400px] max-h-[90vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="dateRangeModalContent">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div class="flex items-center gap-3"><div class="w-10 h-10 bg-teal-50 dark:bg-teal-900/30 text-teal-600 dark:text-teal-400 rounded-xl flex items-center justify-center"><i class="fa-solid fa-calendar-alt text-lg"></i></div><h3 class="font-bold text-lg text-slate-900 dark:text-white">Pilih Tanggal</h3></div>
                <button onclick="closeDateRangeModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <div><h4 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mb-3">Pilihan Cepat</h4><div class="grid grid-cols-2 gap-3" id="quickDateGrid"></div></div>
                <div class="pt-2">
                    <div class="flex justify-between items-center mb-4 sticky top-0 bg-white dark:bg-slate-900 z-10 py-1"><h4 class="text-xs font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest">Kustom</h4><span class="text-xs font-bold text-teal-600 dark:text-teal-400 bg-teal-50 dark:bg-teal-900/30 px-3 py-1 rounded-lg border border-teal-100 dark:border-teal-800/50" id="manualDateDisplay">-</span></div>
                    <div class="grid grid-cols-7 text-center mb-3"><div class="text-[10px] font-black text-red-500">MIN</div><div class="text-[10px] font-black text-slate-400">SEN</div><div class="text-[10px] font-black text-slate-400">SEL</div><div class="text-[10px] font-black text-slate-400">RAB</div><div class="text-[10px] font-black text-slate-400">KAM</div><div class="text-[10px] font-black text-slate-400">JUM</div><div class="text-[10px] font-black text-slate-400">SAB</div></div>
                    <div class="h-64 overflow-y-auto pr-1 space-y-6 custom-scrollbar pb-10" id="yearCalendarContainer"></div>
                </div>
            </div>
            <div class="px-6 py-5 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 pb-safe-bottom">
                <button id="btnApplyDate" onclick="applyDateFilter()" class="w-full py-3.5 rounded-xl bg-teal-600 hover:bg-teal-700 text-white font-bold text-sm shadow-lg shadow-teal-500/30 transition active:scale-[0.98]">Terapkan Filter</button>
            </div>
        </div>
    </div>

    <!-- RULES MODAL -->
    <div id="rulesModal" class="fixed inset-0 z-[60] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-md transition-opacity" onclick="closeRulesModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-5xl h-[90vh] sm:h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="rulesModalContent">
            <div class="px-5 py-4 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <div><h3 class="font-bold text-xl text-slate-900 dark:text-white">Aturan Otomatis</h3><p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Kelola otomasi kampanye Anda.</p></div>
                <button onclick="closeRulesModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-5 overflow-y-auto flex-1 bg-slate-50 dark:bg-slate-950/50">
                <div class="flex flex-col sm:flex-row gap-4 mb-6 justify-between items-start sm:items-center">
                    <div class="relative w-full sm:w-auto min-w-[240px]"><div class="absolute inset-y-0 left-0 pl-3.5 flex items-center pointer-events-none"><i class="fa-solid fa-filter text-slate-400 text-sm"></i></div><select id="rulesAccountFilter" onchange="renderRulesTable()" class="appearance-none w-full pl-10 pr-10 py-3 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-xl text-sm font-bold text-slate-700 dark:text-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500/50 focus:border-blue-500 transition shadow-sm h-12"></select><div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none"><i class="fa-solid fa-chevron-down text-slate-400 text-xs"></i></div></div>
                    <button id="btnOpenCreateRule" onclick="openCreateRuleModal()" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold text-sm px-6 py-3 rounded-xl shadow-lg shadow-green-500/20 transition active:scale-[0.98] flex items-center justify-center gap-2 h-12"><i class="fa-solid fa-plus"></i> Buat Aturan Baru</button>
                </div>
                <div class="bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-2xl shadow-sm overflow-hidden"><div class="overflow-x-auto"><table class="min-w-full table-fixed rules-table" id="rulesTable"><thead><tr><th class="w-[20%]">Target Level</th><th class="w-[30%]">Nama Aturan</th><th class="w-[20%]">Status</th><th class="w-[30%]">Log Terakhir</th><th class="w-[20%] text-center">Aksi</th></tr></thead><tbody id="rulesTableBody"></tbody></table></div></div>
            </div>
        </div>
    </div>

    <!-- CREATE/EDIT RULE MODAL -->
    <div id="createRuleModal" class="fixed inset-0 z-[70] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="closeCreateRuleModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-2xl max-h-[90vh] sm:max-h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="createRuleModalContent">
            <div class="px-6 py-5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <div><h3 class="text-xl font-bold text-slate-900 dark:text-white" id="createRuleModalTitle">Buat Aturan</h3><p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5">Otomatisasi 24/7 untuk akun iklan Anda.</p></div>
                <button onclick="closeCreateRuleModal()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-xmark text-lg"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6 bg-slate-50 dark:bg-slate-950/30">
                <div class="space-y-5 bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Nama Aturan</label><input type="text" id="crName" placeholder="Contoh: Matikan Iklan Mahal" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-700 rounded-xl text-sm font-medium bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition h-12"></div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-5">
                        <div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Target</label><div class="relative"><select id="crTarget" onchange="handleTargetChange()" class="w-full appearance-none px-4 py-3 border border-slate-300 dark:border-slate-700 rounded-xl text-sm font-medium bg-white dark:bg-slate-800 text-slate-900 dark:text-white h-12"><option value="campaign">Campaign (Kampanye)</option><option value="adset">Ad Set (Set Iklan)</option><option value="ad">Ad (Iklan)</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                        <div><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 mb-2 uppercase tracking-wide">Tindakan</label><div class="relative"><select id="crAction" onchange="handleActionChange()" class="w-full appearance-none px-4 py-3 border border-slate-300 dark:border-slate-700 rounded-xl text-sm font-medium bg-white dark:bg-slate-800 text-slate-900 dark:text-white h-12"><option disabled selected value="">Pilih aksi...</option><optgroup label="Status"><option value="turn_off">Matikan (Turn Off)</option><option value="turn_on">Nyalakan (Turn On)</option></optgroup><optgroup label="Budget (Opt)" id="optBudget"><option value="increase_budget">Naikkan Budget</option><option value="decrease_budget">Turunkan Budget</option><option value="reset_budget">Reset Budget</option></optgroup></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                    </div>
                </div>
                <div id="actionValueContainer" class="hidden p-5 bg-blue-50 dark:bg-blue-900/10 rounded-2xl border border-blue-100 dark:border-blue-900/30">
                    <label class="block text-xs font-bold text-blue-600 dark:text-blue-300 uppercase mb-2" id="actionValueLabel">Nilai Penyesuaian</label>
                    <div class="flex gap-3"><input type="number" id="crActionValue" placeholder="0" class="flex-1 px-4 py-3 border border-blue-200 dark:border-blue-800 rounded-xl text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 h-12"><div class="relative w-28"><select id="crActionUnit" class="w-full appearance-none px-4 py-3 border border-blue-200 dark:border-blue-800 rounded-xl text-sm font-bold bg-white dark:bg-slate-900 text-slate-700 dark:text-white h-12"><option value="percent">%</option><option value="currency">IDR</option></select><i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div></div>
                </div>
                
                <!-- NEW: BUDGET LIMIT CARD -->
                <div id="budgetLimitContainer" class="hidden p-5 bg-orange-50 dark:bg-orange-900/10 rounded-2xl border border-orange-100 dark:border-orange-900/30 mt-4">
                    <label class="block text-xs font-bold text-orange-600 dark:text-orange-300 uppercase mb-2" id="budgetLimitLabel">Batas Anggaran</label>
                    <div class="relative">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold">Rp</span>
                        <input type="number" id="crBudgetLimit" placeholder="0" class="w-full pl-12 pr-4 py-3 border border-orange-200 dark:border-orange-800 rounded-xl text-sm bg-white dark:bg-slate-900 text-slate-900 dark:text-white focus:ring-2 focus:ring-orange-500 h-12">
                    </div>
                    <p class="text-[10px] text-slate-500 dark:text-slate-400 mt-2 italic" id="budgetLimitHelpText">...</p>
                </div>

                <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm mt-5">
                    <div class="flex justify-between items-center mb-4"><label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wide">Kondisi Pemicu</label><button onclick="clearAllConditions()" class="text-xs text-red-500 font-bold hover:text-red-600 px-2 py-1">Reset</button></div>
                    <div id="conditionErrorMsg" class="hidden mb-4 p-3 bg-red-50 dark:bg-red-900/20 text-red-600 dark:text-red-400 text-xs font-medium rounded-xl border border-red-200 dark:border-red-800 flex items-start gap-2"><i class="fa-solid fa-circle-exclamation mt-0.5"></i> <span></span></div>
                    <div id="addedConditionsList" class="space-y-2 mb-4"></div>
                    <div class="flex flex-col gap-3 p-4 border border-dashed border-slate-300 dark:border-slate-700 rounded-xl bg-slate-50/50 dark:bg-slate-800/30">
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                             <div id="metricDropdownTrigger" onclick="toggleConditionMenu()" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl bg-white dark:bg-slate-800 text-sm font-medium text-slate-700 dark:text-slate-200 flex justify-between items-center cursor-pointer h-12"><span id="selectedMetricLabel">Pilih Metrik...</span><i class="fa-solid fa-caret-down text-slate-400"></i></div>
                            <div id="conditionMenu" class="hidden absolute left-4 right-4 mt-12 max-h-60 overflow-y-auto bg-white dark:bg-slate-800 border border-slate-200 dark:border-slate-700 rounded-xl shadow-2xl z-50 p-0"></div>
                            <input type="hidden" id="crMetric" value=""><input type="hidden" id="crMetricType" value="NUMBER">
                            <div class="relative"><select id="crOperator" class="w-full appearance-none px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl text-sm bg-white dark:bg-slate-800 text-slate-700 dark:text-slate-200 h-12"></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div>
                        </div>
                        <div class="flex gap-3"><div class="relative flex-1" id="conditionValueContainer"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 text-sm font-bold hidden" id="crCurrencyLabel">Rp</span><input type="number" id="crValue" class="w-full px-4 py-3 border border-slate-300 dark:border-slate-600 rounded-xl text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white focus:ring-2 focus:ring-blue-500 h-12" placeholder="Nilai"></div><button id="btnAddCondition" onclick="addConditionToRule()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl text-sm hover:bg-blue-700 shadow-md h-12"><i class="fa-solid fa-plus"></i></button></div>
                    </div>
                </div>
                <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-3">Rentang Data</label>
                    <div class="relative"><select id="crTimeRange" class="w-full appearance-none px-4 py-3 border border-slate-300 dark:border-slate-700 rounded-xl text-sm bg-white dark:bg-slate-800 text-slate-900 dark:text-white h-12 font-medium"><option value="today">Hari ini (Today)</option><option value="yesterday">Kemarin (Yesterday)</option><option value="last_3d">3 hari terakhir</option><option value="last_7d" selected>7 hari terakhir</option><option value="last_14d">14 hari terakhir</option><option value="last_30d">30 hari terakhir</option><option value="maximum">Maksimum (Lifetime)</option></select><i class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i></div>
                </div>
                
                <!-- JADWAL EKSEKUSI -->
                <div class="bg-white dark:bg-slate-900 p-5 rounded-2xl border border-slate-100 dark:border-slate-800 shadow-sm">
                    <label class="block text-xs font-bold text-slate-500 dark:text-slate-400 uppercase mb-3 tracking-wide">Jadwal Eksekusi</label>
                    <div class="space-y-4">
                        <label class="flex items-start gap-3 cursor-pointer group"><input type="radio" name="ruleSchedule" value="continuous" class="mt-1" checked onchange="toggleCustomSchedule()"><div><span class="block text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-green-600 transition">Berkelanjutan (Continuously)</span><span class="block text-[11px] text-slate-500 mt-0.5">Aturan berjalan secara otomatis setiap 5 menit.</span></div></label>
                        <label class="flex items-start gap-3 cursor-pointer group"><input type="radio" name="ruleSchedule" value="daily" class="mt-1" onchange="toggleCustomSchedule()"><div><span class="block text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-green-600 transition">Harian (Daily)</span><span class="block text-[11px] text-slate-500 mt-0.5">Aturan berjalan satu kali sehari pada jam 12:00 AM.</span></div></label>
                        <label class="flex items-start gap-3 cursor-pointer group"><input type="radio" name="ruleSchedule" value="custom" class="mt-1" onchange="toggleCustomSchedule()"><div><span class="block text-sm font-bold text-slate-700 dark:text-slate-200 group-hover:text-green-600 transition">Kustom (Custom)</span><span class="block text-[11px] text-slate-500 mt-0.5">Pilih jam spesifik eksekusi.</span></div></label>
                        
                        <div id="customScheduleContainer" class="hidden ml-7 mt-2 pl-4 border-l-2 border-slate-200 dark:border-slate-700 space-y-3 transition-all"></div>
                    </div>
                </div>
            </div>
            <div class="px-6 py-5 border-t border-slate-200 dark:border-slate-800 bg-white dark:bg-slate-900 pb-safe-bottom flex gap-3">
                <button onclick="closeCreateRuleModal()" class="flex-1 py-3.5 rounded-xl border border-slate-300 dark:border-slate-700 text-slate-700 dark:text-slate-300 text-sm font-bold hover:bg-slate-50 dark:hover:bg-slate-800 transition">Batal</button>
                <button id="btnSaveRule" onclick="saveRule()" disabled class="flex-1 py-3.5 rounded-xl bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold shadow-lg shadow-blue-500/30 disabled:opacity-50 disabled:shadow-none transition">Simpan Aturan</button>
            </div>
        </div>
    </div>

    <!-- LOG DETAIL MODAL -->
    <div id="ruleLogsModal" class="fixed inset-0 z-[80] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm transition-opacity" onclick="closeRuleLogsModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-3xl max-h-[85vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="ruleLogsModalContent">
            <div class="px-6 py-5 border-b border-slate-200 dark:border-slate-800 flex justify-between items-center">
                <div><h3 class="font-bold text-lg text-slate-900 dark:text-white">Riwayat Eksekusi</h3><p class="text-xs text-slate-500 dark:text-slate-400 mt-0.5" id="logModalRuleName">...</p></div>
                <button onclick="closeRuleLogsModal()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-0 overflow-y-auto flex-1 bg-slate-50 dark:bg-slate-950/50"><table class="min-w-full table-fixed rules-table"><thead><tr><th class="w-[20%] pl-6">Waktu</th><th class="w-[20%]">Level</th><th class="w-[30%]">Aset</th><th class="w-[20%]">Aksi</th><th class="w-[10%] text-center pr-6">Hasil</th></tr></thead><tbody id="ruleLogsModalBody"></tbody></table></div>
        </div>
    </div>

    <!-- ACCOUNT MANAGEMENT MODAL -->
    <div id="accountModal" class="fixed inset-0 z-[90] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeAccountModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-md max-h-[90vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="accountModalContent">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <h3 class="font-bold text-lg text-slate-900 dark:text-white">Kelola Akun</h3>
                <button onclick="closeAccountModal()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1 space-y-6">
                <div><p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-4">Hubungkan Akun Baru</p><div class="bg-blue-50/50 dark:bg-blue-900/10 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/30 space-y-4"><input type="text" id="inputName" placeholder="Nama Akun" class="w-full px-4 py-3 rounded-xl border border-blue-200 dark:border-blue-800 bg-white dark:bg-slate-950 text-slate-900 dark:text-white text-sm h-12"><input type="text" id="inputId" placeholder="Ad Account ID (act_xxx)" class="w-full px-4 py-3 rounded-xl border border-blue-200 dark:border-blue-800 bg-white dark:bg-slate-950 text-slate-900 dark:text-white text-sm h-12"><input type="password" id="inputToken" placeholder="Access Token" class="w-full px-4 py-3 rounded-xl border border-blue-200 dark:border-blue-800 bg-white dark:bg-slate-950 text-slate-900 dark:text-white text-sm h-12"><button onclick="saveAccount()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl text-sm shadow-md h-12">Hubungkan Akun</button></div></div>
                <div><p class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-widest mb-3">Akun Tersimpan</p><div id="accountListContainer" class="space-y-3"></div></div>
            </div>
        </div>
    </div>

    <!-- BUDGET EDIT MODAL -->
    <div id="budgetModal" class="fixed inset-0 z-[80] hidden flex items-end sm:items-center justify-center sm:p-4">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="closeBudgetModal()"></div>
        <div class="bg-white dark:bg-slate-900 w-full sm:max-w-sm max-h-[90vh] flex flex-col rounded-t-3xl sm:rounded-3xl shadow-2xl relative z-10 transform transition-transform duration-300 translate-y-full sm:translate-y-0 sm:scale-95 sm:opacity-0" id="budgetModalContent">
            <div class="px-6 py-5 border-b border-slate-100 dark:border-slate-800 flex justify-between items-center">
                <div class="flex items-center gap-3"><div class="w-10 h-10 bg-blue-50 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 rounded-xl flex items-center justify-center"><i class="fa-solid fa-coins"></i></div><div><h3 class="font-bold text-slate-900 dark:text-white">Ubah Budget</h3><p class="text-xs text-slate-500 dark:text-slate-400">Campaign Level</p></div></div>
                <button onclick="closeBudgetModal()" class="w-9 h-9 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-500 dark:text-slate-400 flex items-center justify-center hover:bg-slate-200 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-6">
                <div class="text-center p-4 bg-slate-50 dark:bg-slate-800/50 rounded-2xl border border-slate-100 dark:border-slate-800"><p class="text-xs text-slate-500 dark:text-slate-400 uppercase font-bold mb-1">Saat Ini</p><p class="text-2xl font-black text-slate-900 dark:text-white tracking-tight" id="currentBudgetDisplay">Rp 0</p><span class="text-[10px] px-2.5 py-0.5 bg-blue-100 dark:bg-blue-900/40 text-blue-700 dark:text-blue-300 rounded-full font-bold mt-1 inline-block" id="budgetTypeLabel">Harian</span></div>
                <div class="space-y-4">
                    <div class="flex gap-3"><button onclick="setBudgetMode('increase')" id="btnIncrease" class="flex-1 py-3 rounded-xl border border-transparent bg-green-50 text-green-700 dark:bg-green-900/20 dark:text-green-400 font-bold text-xs h-12 flex items-center justify-center gap-2 transition"><i class="fa-solid fa-arrow-up"></i> Naikkan</button><button onclick="setBudgetMode('decrease')" id="btnDecrease" class="flex-1 py-3 rounded-xl border border-transparent bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400 font-bold text-xs h-12 flex items-center justify-center gap-2 transition"><i class="fa-solid fa-arrow-down"></i> Turunkan</button></div>
                    <div class="p-1 bg-slate-100 dark:bg-slate-800 rounded-xl flex"><button onclick="setBudgetType('fixed')" id="btnTypeFixed" class="flex-1 py-2 rounded-lg text-xs font-bold transition shadow-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-white">Nominal (Rp)</button><button onclick="setBudgetType('percent')" id="btnTypePercent" class="flex-1 py-2 rounded-lg text-xs font-bold text-slate-500 dark:text-slate-400 transition hover:text-slate-700">Persen (%)</button></div>
                    <div class="relative"><span class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm" id="inputPrefix">Rp</span><input type="number" id="budgetInput" oninput="calculatePreview()" class="w-full pl-12 pr-12 py-3.5 rounded-xl border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-900 text-slate-900 dark:text-white font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition h-14" placeholder="0"><span class="absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 font-bold text-sm hidden" id="inputSuffix">%</span></div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/10 p-5 rounded-2xl border border-blue-100 dark:border-blue-900/30 flex justify-between items-center"><span class="text-xs text-slate-500 dark:text-slate-400 font-bold">Estimasi Baru</span><div class="text-right"><p class="text-xl font-black text-slate-900 dark:text-white leading-none" id="previewNewBudget">Rp 0</p><span class="text-[10px] font-bold text-blue-600 dark:text-blue-400" id="previewChange">0%</span></div></div>
            </div>
            <div class="px-6 py-5 border-t border-slate-100 dark:border-slate-800 bg-white dark:bg-slate-900 pb-safe-bottom flex gap-3">
                <button onclick="closeBudgetModal()" class="flex-1 py-3.5 rounded-xl bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 font-bold text-sm hover:bg-slate-200 dark:hover:bg-slate-700 transition">Batal</button>
                <button onclick="confirmBudgetUpdate()" class="flex-1 py-3.5 rounded-xl bg-blue-600 text-white font-bold text-sm shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition">Simpan</button>
            </div>
        </div>
    </div>

    <script>
        // --- GLOBAL APP CONFIG & SCHEDULER ---
        const APP_CONFIG = { name: 'AdsTor', tagline: 'Automate. Optimize. Scale.' };
        const SCHEDULER_CONFIG = { interval: 300000, bufferWindow: 0, lockDuration: 290000 };

        // --- CORE CONFIG ---
        const REFRESH_INTERVAL = 300000;
        let accounts = JSON.parse(localStorage.getItem('ads_accounts')) || [];
        let currentAccountId = localStorage.getItem('ads_active_id') || '';
        let CONFIG = { accessToken: '', adAccountId: '', apiVersion: 'v19.0', datePreset: 'last_7d' };
        const HAS_EDIT_PERMISSION = true;

        // --- CONSTANTS & METRICS ---
        const QUICK_DATE_OPTIONS = [ { id: 'today', label: 'Hari Ini' }, { id: 'yesterday', label: 'Kemarin' }, { id: 'last_7d', label: '7 Hari' }, { id: 'last_30d', label: '30 Hari' }, { id: 'this_month', label: 'Bulan Ini' }, { id: 'last_month', label: 'Bulan Lalu' } ];
        function formatIDR(val) { return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(val); }
        function formatNumber(val) { return new Intl.NumberFormat('id-ID').format(val); }
        function formatFloat(val) { return val.toFixed(2); }
        function formatPercent(val) { return val.toFixed(2) + '%'; }
        function formatX(val) { return val.toFixed(2) + 'x'; }

        const METRIC_REGISTRY = {
            spend: { label: 'Spend', meta_field: 'spend', format: formatIDR, icon: 'fa-wallet', color: 'text-slate-900 dark:text-white' },
            impressions: { label: 'Impressions', meta_field: 'impressions', format: formatNumber, icon: 'fa-eye', color: 'text-slate-900 dark:text-white' },
            reach: { label: 'Reach', meta_field: 'reach', format: formatNumber, icon: 'fa-users', color: 'text-slate-900 dark:text-white' },
            frequency: { label: 'Frequency', meta_field: 'frequency', format: formatFloat, icon: 'fa-wave-square', color: 'text-slate-900 dark:text-white' },
            results: { label: 'Results', meta_field: 'results', format: formatNumber, icon: 'fa-trophy', color: 'text-slate-900 dark:text-white' },
            cost_per_result: { label: 'Cost/Result', meta_field: 'cost_per_result', format: formatIDR, icon: 'fa-tag', color: 'text-slate-900 dark:text-white' },
            cpm: { label: 'CPM', meta_field: 'cpm', format: formatIDR, icon: 'fa-bullhorn', color: 'text-slate-900 dark:text-white' },
            link_clicks: { label: 'Link Clicks', meta_field: 'inline_link_clicks', format: formatNumber, icon: 'fa-link', color: 'text-slate-900 dark:text-white' },
            ctr_link: { label: 'CTR (Link)', meta_field: 'inline_link_click_ctr', format: formatPercent, icon: 'fa-percent', color: 'text-blue-600 dark:text-blue-400' },
            cpc_link: { label: 'CPC (Link)', meta_field: 'cost_per_inline_link_click', format: formatIDR, icon: 'fa-mouse-pointer', color: 'text-slate-900 dark:text-white' },
            clicks: { label: 'All Clicks', meta_field: 'clicks', format: formatNumber, icon: 'fa-hand-pointer', color: 'text-slate-900 dark:text-white' },
            ctr_all: { label: 'CTR (All)', meta_field: 'ctr', format: formatPercent, icon: 'fa-percent', color: 'text-slate-900 dark:text-white' },
            post_engagement: { label: 'Engagement', meta_field: 'actions', sub_field: 'post_engagement', format: formatNumber, icon: 'fa-thumbs-up', color: 'text-slate-900 dark:text-white' },
            landing_page_view: { label: 'LP Views', meta_field: 'actions', sub_field: 'landing_page_view', format: formatNumber, icon: 'fa-door-open', color: 'text-slate-900 dark:text-white' },
            purchases: { label: 'Purchases', meta_field: 'actions', sub_field: 'purchase', format: formatNumber, icon: 'fa-shopping-cart', color: 'text-green-600 dark:text-green-400' },
            purchase_value: { label: 'Value', meta_field: 'action_values', sub_field: 'purchase', format: formatIDR, icon: 'fa-sack-dollar', color: 'text-green-600 dark:text-green-400' },
            add_to_cart: { label: 'Add to Cart', meta_field: 'actions', sub_field: 'add_to_cart', format: formatNumber, icon: 'fa-cart-plus', color: 'text-slate-900 dark:text-white' },
            cost_add_to_cart: { label: 'Cost/ATC', meta_field: 'cost_per_action_type', sub_field: 'add_to_cart', format: formatIDR, icon: 'fa-tag', color: 'text-slate-900 dark:text-white' },
            roas: { label: 'ROAS', meta_field: 'purchase_roas', sub_field: 'purchase', format: formatX, icon: 'fa-arrow-trend-up', color: 'text-green-600 dark:text-green-400' },
            cost_purchase: { label: 'Cost/Pur', meta_field: 'cost_per_action_type', sub_field: 'purchase', format: formatIDR, icon: 'fa-money-bill-wave', color: 'text-slate-900 dark:text-white' },
            leads: { label: 'Leads', meta_field: 'actions', sub_field: 'lead', format: formatNumber, icon: 'fa-user-check', color: 'text-blue-600 dark:text-blue-400' },
            cost_lead: { label: 'Cost/Lead', meta_field: 'cost_per_action_type', sub_field: 'lead', format: formatIDR, icon: 'fa-tag', color: 'text-slate-900 dark:text-white' },
            budget: { label: 'Budget', meta_field: 'daily_budget', format: formatIDR, icon: 'fa-coins', color: 'text-slate-900 dark:text-white' }
        };

        const TEXT_METRICS = {
            campaign_name: { label: 'Campaign Name', field: 'name' },
            adset_name: { label: 'Ad Set Name', field: 'name' },
            ad_name: { label: 'Ad Name', field: 'name' }
        };

        const RULE_CONDITIONS_MENU = {
            "Metrik Nama (Text)": Object.keys(TEXT_METRICS).map(key => ({ label: TEXT_METRICS[key].label, type: 'TEXT', key: key })),
            "Metrik Performa (Number)": Object.keys(METRIC_REGISTRY).map(key => ({ label: METRIC_REGISTRY[key].label, type: 'NUMBER', key: key }))
        };

        // --- STATE ---
        let summaryMetrics = JSON.parse(localStorage.getItem('ads_summary_metrics')) || ['spend', 'impressions', 'cpm', 'ctr_link'];
        let campaignMetrics = JSON.parse(localStorage.getItem('ads_campaign_metrics')) || ['results', 'cost_per_result', 'roas', 'budget'];
        let automatedRulesHistory = JSON.parse(localStorage.getItem('ads_rules_history')) || []; 
        if(!Array.isArray(automatedRulesHistory)) automatedRulesHistory = [];

        let currentCampaignData = [];
        let currentAdSetData = [];
        let currentAdData = [];
        
        let currentRuleConditions = [];
        let currentRuleCustomTimes = [];
        let editingConditionId = null;
        let editingRuleId = null; 
        let customDateRange = { start: null, end: null };
        let currentMetricConfigContext = 'summary';

        let budgetState = { campaignId: null, currentAmount: 0, type: 'daily', mode: 'increase', calcType: 'fixed' };

        function initApp() {
            try {
                accounts = JSON.parse(localStorage.getItem('ads_accounts')) || [];
                currentAccountId = localStorage.getItem('ads_active_id') || '';
                if(!localStorage.getItem('ads_summary_metrics')) localStorage.setItem('ads_summary_metrics', JSON.stringify(summaryMetrics));
                if(!localStorage.getItem('ads_campaign_metrics')) localStorage.setItem('ads_campaign_metrics', JSON.stringify(campaignMetrics));
                automatedRulesHistory = JSON.parse(localStorage.getItem('ads_rules_history')) || [];
            } catch (e) { localStorage.clear(); }
            
            document.getElementById('currentDateDisplay').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            
            const opSelect = document.getElementById('crOperator');
            if(opSelect) opSelect.innerHTML = `<option value="greater">Lebih dari (>)</option><option value="smaller">Kurang dari (<)</option><option value="equal">Sama dengan (=)</option>`;

            initTheme(); 
            updateHeaderAccountLabel(); 
            refreshData();
            setInterval(refreshData, REFRESH_INTERVAL);
        }

        // --- AUTH & THEME & UI ---
        function initTheme() {
            const saved = localStorage.getItem('theme');
            const isDark = saved === 'dark' || saved === null; 
            document.documentElement.classList.toggle('dark', isDark);
            if(saved === null) localStorage.setItem('theme', 'dark'); 
            updateThemeIcon(isDark);
        }
        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            updateThemeIcon(isDark);
        }
        function updateThemeIcon(isDark) {
            const btn = document.getElementById('themeToggleBtn');
            if(btn) btn.innerHTML = isDark ? '<i class="fa-solid fa-sun text-yellow-400 text-xs"></i>' : '<i class="fa-solid fa-moon text-xs"></i>';
        }
        function openModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            modal.classList.remove('hidden');
            setTimeout(() => { content.classList.remove('translate-y-full', 'sm:scale-95', 'sm:opacity-0'); content.classList.add('sm:scale-100', 'sm:opacity-100'); }, 10);
        }
        function closeModal(modalId, contentId) {
            const modal = document.getElementById(modalId);
            const content = document.getElementById(contentId);
            content.classList.add('translate-y-full', 'sm:scale-95', 'sm:opacity-0');
            content.classList.remove('sm:scale-100', 'sm:opacity-100');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        // --- MODAL WRAPPERS ---
        function openDateRangeModal() { openModal('dateRangeModal', 'dateRangeModalContent'); renderQuickDateOptions(); renderCalendarUI(); }
        function closeDateRangeModal() { closeModal('dateRangeModal', 'dateRangeModalContent'); }
        function openRulesModal() { openModal('rulesModal', 'rulesModalContent'); renderRulesAccountSelector(); renderRulesTable(); }
        function closeRulesModal() { closeModal('rulesModal', 'rulesModalContent'); }
        function openCreateRuleModal() { 
            editingRuleId = null;
            document.getElementById('createRuleModalTitle').innerText = 'Buat Aturan';
            document.getElementById('btnSaveRule').innerText = 'Simpan Aturan';
            document.getElementById('crName').value = '';
            document.getElementById('crTarget').value = 'campaign'; 
            document.getElementById('crAction').value = '';
            document.getElementById('crActionValue').value = '';
            document.getElementById('crBudgetLimit').value = ''; 
            currentRuleCustomTimes = [];
            handleTargetChange();
            clearAllConditions();
            openModal('createRuleModal', 'createRuleModalContent'); 
        }
        function closeCreateRuleModal() { closeModal('createRuleModal', 'createRuleModalContent'); }
        function openAccountModal() { renderAccountList(); openModal('accountModal', 'accountModalContent'); }
        function closeAccountModal() { closeModal('accountModal', 'accountModalContent'); }
        function openAccountSelectModal() { renderAccountSelectionList(); openModal('accountSelectModal', 'accountSelectModalContent'); }
        function closeAccountSelectModal() { closeModal('accountSelectModal', 'accountSelectModalContent'); }
        function openMetricConfigModal(context) {
            currentMetricConfigContext = context;
            document.getElementById('metricConfigTitle').innerText = context === 'summary' ? 'Metrik Ringkasan' : 'Metrik Kampanye';
            document.getElementById('metricConfigSubtitle').innerText = context === 'summary' ? 'Pilih data untuk ditampilkan di kartu atas.' : 'Pilih kolom untuk tabel kampanye.';
            renderMetricConfigSelector();
            openModal('metricConfigModal', 'metricConfigModalContent');
        }
        function closeMetricConfigModal() { closeModal('metricConfigModal', 'metricConfigModalContent'); }
        function openBudgetModal(campId, currentAmount, type) {
            if (!HAS_EDIT_PERMISSION) { Swal.fire({ icon: 'error', title: 'Akses Ditolak', text: 'Izin tidak cukup.' }); return; }
            budgetState = { campaignId: campId, currentAmount: parseFloat(currentAmount), type: type || 'daily', mode: 'increase', calcType: 'fixed' };
            document.getElementById('currentBudgetDisplay').innerText = formatIDR(currentAmount);
            document.getElementById('budgetTypeLabel').innerText = type === 'lifetime' ? 'Lifetime' : 'Harian';
            document.getElementById('budgetInput').value = '';
            setBudgetMode('increase');
            openModal('budgetModal', 'budgetModalContent');
        }
        function closeBudgetModal() { closeModal('budgetModal', 'budgetModalContent'); }
        function openRuleLogsModal() { openModal('ruleLogsModal', 'ruleLogsModalContent'); }
        function closeRuleLogsModal() { closeModal('ruleLogsModal', 'ruleLogsModalContent'); }

        // --- ACCOUNT LOGIC ---
        function updateHeaderAccountLabel() { const acc = accounts.find(a => a.id === currentAccountId); document.getElementById('headerAccountLabel').innerText = acc ? acc.name : 'Demo Mode'; }
        function renderAccountSelectionList() {
            const container = document.getElementById('accountSelectionList');
            let html = `<div onclick="switchAccount('demo')" class="p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition flex items-center justify-between border-b border-slate-100 dark:border-slate-800 last:border-0 group"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 flex items-center justify-center font-bold text-xs">D</div><div><p class="text-sm font-bold text-slate-800 dark:text-white group-hover:text-blue-600 transition">Demo Mode</p><p class="text-xs text-slate-500">Simulasi Data</p></div></div>${!currentAccountId ? '<i class="fa-solid fa-check text-blue-600"></i>' : ''}</div>`;
            if(accounts.length > 0) { html += accounts.map(acc => `<div onclick="switchAccount('${acc.id}')" class="p-4 cursor-pointer hover:bg-slate-50 dark:hover:bg-slate-800 transition flex items-center justify-between border-b border-slate-100 dark:border-slate-800 last:border-0 group"><div class="flex items-center gap-3"><div class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-400 flex items-center justify-center font-bold text-xs">${acc.name.charAt(0).toUpperCase()}</div><div><p class="text-sm font-bold text-slate-800 dark:text-white group-hover:text-blue-600 transition">${acc.name}</p><p class="text-xs text-slate-500 font-mono">${acc.adAccountId}</p></div></div>${currentAccountId === acc.id ? '<i class="fa-solid fa-check text-blue-600"></i>' : ''}</div>`).join(''); }
            container.innerHTML = html;
        }
        function switchAccount(id) { currentAccountId = id === 'demo' ? '' : id; localStorage.setItem('ads_active_id', currentAccountId); updateHeaderAccountLabel(); closeAccountSelectModal(); refreshData(); }
        function saveAccount() {
             const name = document.getElementById('inputName').value.trim(); const idInput = document.getElementById('inputId').value.trim(); const token = document.getElementById('inputToken').value.trim();
             if(!name || !idInput || !token) { Swal.fire({ icon: 'error', text: 'Lengkapi semua field.' }); return; }
             const exists = accounts.some(acc => acc.adAccountId === idInput); if (exists) { Swal.fire({ icon: 'warning', text: 'Akun sudah ada.' }); return; }
             const newAccount = { id: Date.now().toString(), name: name, adAccountId: idInput, accessToken: token };
             accounts.push(newAccount); localStorage.setItem('ads_accounts', JSON.stringify(accounts));
             renderAccountList(); updateHeaderAccountLabel(); if (accounts.length === 1) switchAccount(newAccount.id);
             document.getElementById('inputName').value = ''; document.getElementById('inputId').value = ''; document.getElementById('inputToken').value = '';
             Swal.fire({ icon: 'success', title: 'Berhasil', timer: 1500, showConfirmButton: false });
        }
        function renderAccountList() { const container = document.getElementById('accountListContainer'); if(!container) return; if(accounts.length === 0) { container.innerHTML = '<p class="text-xs text-slate-400 text-center py-4 bg-slate-50 dark:bg-slate-800 rounded-xl">Belum ada akun.</p>'; return; } container.innerHTML = accounts.map(acc => `<div class="flex items-center justify-between p-4 bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 rounded-xl"><div class="flex-1"><p class="text-sm font-bold text-slate-900 dark:text-white">${acc.name}</p><p class="text-xs text-slate-500 font-mono mt-0.5">${acc.adAccountId}</p></div><button onclick="removeAccount('${acc.id}')" class="text-red-500 p-2 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition"><i class="fa-solid fa-trash"></i></button></div>`).join(''); }
        function removeAccount(id) { if(confirm('Hapus akun?')) { accounts = accounts.filter(a => a.id !== id); localStorage.setItem('ads_accounts', JSON.stringify(accounts)); if(currentAccountId === id) { currentAccountId = ''; updateHeaderAccountLabel(); } renderAccountList(); refreshData(); } }

        // --- DATA PROCESSING & UI ---
        function normalizeCampaignData(rawCampaign, rawInsights) {
            const metrics = rawInsights || {};
            let budget = 0; let budgetType = 'daily';
            if (rawCampaign.daily_budget) { budget = parseFloat(rawCampaign.daily_budget); budgetType = 'daily'; } else if (rawCampaign.lifetime_budget) { budget = parseFloat(rawCampaign.lifetime_budget); budgetType = 'lifetime'; }
            const normalized = { id: rawCampaign.id, campaign_id: rawCampaign.id, name: rawCampaign.name, status: rawCampaign.status, effective_status: rawCampaign.effective_status, budget: budget, budget_type: budgetType };
            Object.keys(METRIC_REGISTRY).forEach(key => {
                const def = METRIC_REGISTRY[key];
                if (def.sub_field) { const list = metrics[def.meta_field] || []; const item = list.find(x => x.action_type === def.sub_field || (def.sub_field === 'purchase' && x.action_type === 'omni_purchase')); normalized[key] = item ? parseFloat(item.value) : 0; } 
                else { if (def.meta_field === 'daily_budget') normalized[key] = budget; else normalized[key] = metrics[def.meta_field] ? parseFloat(metrics[def.meta_field]) : 0; }
            });
            return normalized;
        }

        async function refreshData() {
            const icon = document.getElementById('refreshIcon');
            icon.classList.add('fa-spin');
            const acc = accounts.find(a => a.id === currentAccountId);
            if(acc) { CONFIG.accessToken = acc.accessToken; CONFIG.adAccountId = acc.adAccountId; await runLiveMode(); } else { runMockMode(); }
            runAutomatedRules();
            icon.classList.remove('fa-spin');
        }

        async function runLiveMode() {
            try {
                let rawId = (CONFIG.adAccountId || '').trim().replace(/^act_/i, '');
                CONFIG.adAccountId = 'act_' + rawId;
                const fieldSet = new Set(['campaign_id']);
                Object.values(METRIC_REGISTRY).forEach(def => { if (def.meta_field !== 'daily_budget') fieldSet.add(def.meta_field); });
                const insightFields = Array.from(fieldSet).join(',');
                let dateParam = CONFIG.datePreset ? `date_preset=${CONFIG.datePreset}` : (customDateRange.start ? `time_range=${JSON.stringify({ since: customDateRange.start.toISOString().split('T')[0], until: (customDateRange.end || customDateRange.start).toISOString().split('T')[0] })}` : `date_preset=last_7d`);
                const campRes = await fetch(`https://graph.facebook.com/${CONFIG.apiVersion}/${CONFIG.adAccountId}/campaigns?fields=id,name,status,effective_status,daily_budget,lifetime_budget&limit=500&access_token=${CONFIG.accessToken}`);
                const campJson = await campRes.json();
                if(campJson.error) throw new Error(campJson.error.message);
                const insightRes = await fetch(`https://graph.facebook.com/${CONFIG.apiVersion}/${CONFIG.adAccountId}/insights?level=campaign&${dateParam}&fields=${insightFields}&limit=500&access_token=${CONFIG.accessToken}`);
                const insightJson = await insightRes.json();
                const insightsMap = {}; (insightJson.data || []).forEach(i => insightsMap[i.campaign_id] = i);
                const mergedData = (campJson.data || []).map(camp => { return normalizeCampaignData(camp, insightsMap[camp.id]); });
                processDataAndUI(mergedData);
            } catch (e) { console.error(e); runMockMode(); }
        }

        function runMockMode() {
            // 1. Mock Campaigns
            const mockCamps = [{ id: 'c1', name: "Promo Sales - Jakarta", status: 'ACTIVE', daily_budget: 500000 }, { id: 'c2', name: "Traffic Website", status: 'PAUSED', daily_budget: 200000 }];
            const mockInsights = { 'c1': { spend: '1500000', impressions: '50000', reach: '40000', frequency: '1.25', cpm: '30000', results: '20', cost_per_result: '75000', inline_link_clicks: '500', inline_link_click_ctr: '1.0', cost_per_inline_link_click: '3000', actions: [{action_type:'purchase', value:'20'}, {action_type:'lead', value:'50'}, {action_type:'add_to_cart', value:'100'}, {action_type:'landing_page_view', value:'300'}], action_values: [{action_type:'purchase', value:'6000000'}], cost_per_action_type: [{action_type:'purchase', value:'75000'}, {action_type:'lead', value:'30000'}, {action_type:'add_to_cart', value:'15000'}], purchase_roas: [{action_type:'omni_purchase', value:'4.0'}] }, 'c2': { spend: '400000', impressions: '15000', inline_link_clicks: '500', ctr: '3.33', clicks: '600', actions: [{action_type:'landing_page_view', value:'450'}] } };
            const merged = mockCamps.map(c => normalizeCampaignData(c, mockInsights[c.id]));
            processDataAndUI(merged);

            // 2. Mock Ad Sets
            currentAdSetData = [
                { id: 'as1', campaign_id: 'c1', name: 'AdSet - Jakarta Selatan', status: 'ACTIVE', spend: 500000, roas: 3.5 },
                { id: 'as2', campaign_id: 'c1', name: 'AdSet - Jakarta Barat', status: 'ACTIVE', spend: 1000000, roas: 4.5 }
            ];

            // 3. Mock Ads
            currentAdData = [
                { id: 'ad1', adset_id: 'as1', name: 'Video - Testimoni 1', status: 'ACTIVE', spend: 200000, roas: 2.0 },
                { id: 'ad2', adset_id: 'as1', name: 'Image - Diskon 50%', status: 'ACTIVE', spend: 300000, roas: 5.0 }
            ];
        }

        function processDataAndUI(campaigns) {
            currentCampaignData = campaigns;
            let totals = {}; Object.keys(METRIC_REGISTRY).forEach(k => totals[k] = 0);
            campaigns.forEach(c => { Object.keys(METRIC_REGISTRY).forEach(k => { if (['spend', 'impressions', 'clicks', 'link_clicks', 'purchases', 'leads', 'add_to_cart', 'purchase_value', 'landing_page_view', 'post_engagement', 'budget'].includes(k)) { totals[k] += (c[k] || 0); } }); });
            if(totals.spend > 0) {
                if (totals.impressions > 0) totals.cpm = (totals.spend / totals.impressions) * 1000;
                if (totals.clicks > 0) totals.cpc_link = totals.spend / totals.link_clicks;
                if (totals.purchases > 0) { totals.cost_purchase = totals.spend / totals.purchases; totals.roas = totals.purchase_value / totals.spend; }
                if (totals.add_to_cart > 0) totals.cost_add_to_cart = totals.spend / totals.add_to_cart;
                if (totals.leads > 0) totals.cost_lead = totals.spend / totals.leads;
            }
            const grid = document.getElementById('summaryGrid');
            if(grid) {
                grid.innerHTML = '';
                summaryMetrics.forEach(key => {
                    const conf = METRIC_REGISTRY[key]; if(!conf) return;
                    let val = totals[key] || 0;
                    if (['reach', 'frequency', 'results', 'cost_per_result', 'ctr_link', 'ctr_all'].includes(key)) val = 0; 
                    grid.innerHTML += `<div class="bg-white dark:bg-slate-900 p-5 rounded-3xl card-shadow border border-slate-100 dark:border-slate-800 transition hover:scale-[1.02]"><div class="flex items-center gap-2 mb-2 text-slate-500 dark:text-slate-400"><i class="fa-solid ${conf.icon} text-sm"></i><span class="text-[10px] uppercase font-black tracking-widest">${conf.label}</span></div><p class="text-2xl font-black ${conf.color}">${val === 0 && !['spend','impressions'].includes(key) ? '-' : conf.format(val)}</p></div>`;
                });
            }
            const list = document.getElementById('campaignList');
            if(list) {
                list.innerHTML = campaigns.map(c => {
                    return `<div class="bg-white dark:bg-slate-900 p-5 rounded-3xl border border-slate-100 dark:border-slate-800 card-shadow mb-4"><div class="flex justify-between items-start mb-4"><h4 class="font-bold text-sm text-slate-900 dark:text-white truncate pr-2">${c.name}</h4><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleCampaignStatus('${c.id}', this.checked)" ${c.status === 'ACTIVE' ? 'checked' : ''}><div class="w-10 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div></label></div><div class="grid grid-cols-2 gap-3">${campaignMetrics.map(k => { const conf = METRIC_REGISTRY[k]; if(k === 'budget') { return `<div class="px-3 py-2 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50 flex items-center justify-between"><div><p class="text-[9px] text-slate-400 uppercase font-bold truncate">${conf.label}</p><p class="text-xs font-black text-slate-700 dark:text-slate-200 leading-none mt-0.5">${conf.format(c[k] || 0)}</p></div><button onclick="openBudgetModal('${c.id}', ${c.budget}, '${c.budget_type}')" class="w-7 h-7 flex items-center justify-center bg-white dark:bg-slate-700 rounded-full text-slate-500 hover:text-blue-600 shadow-sm"><i class="fa-solid fa-pencil text-[10px]"></i></button></div>`; } return conf ? `<div class="px-3 py-2 bg-slate-50 dark:bg-slate-800/50 rounded-xl border border-slate-100 dark:border-slate-700/50"><p class="text-[9px] text-slate-400 uppercase font-bold truncate">${conf.label}</p><p class="text-xs font-black text-slate-700 dark:text-slate-200 leading-none mt-0.5">${conf.format(c[k] || 0)}</p></div>` : ''; }).join('')}</div></div>`;
                }).join('');
            }
        }

        // --- SHARED METRIC CONFIG LOGIC ---
        function renderMetricConfigSelector() {
             const targetList = currentMetricConfigContext === 'summary' ? summaryMetrics : campaignMetrics;
             const activeContainer = document.getElementById('configActiveMetricsList');
             activeContainer.innerHTML = targetList.map(key => { 
                 const m = METRIC_REGISTRY[key]; 
                 return m ? `<span class="inline-flex items-center gap-1 bg-blue-50 dark:bg-blue-900/30 text-blue-700 dark:text-blue-300 px-2.5 py-1.5 rounded-lg text-xs font-bold border border-blue-100 dark:border-blue-800">${m.label} <button onclick="removeMetricFromConfig('${key}')" class="hover:text-red-500 ml-1.5"><i class="fa-solid fa-xmark"></i></button></span>` : ''; 
             }).join('');
             const dropdown = document.getElementById('configAvailableMetrics');
             const available = Object.keys(METRIC_REGISTRY).filter(k => !targetList.includes(k)); 
             dropdown.innerHTML = '<option value="">+ Tambah Metrik...</option>' + available.map(k => `<option value="${k}">${METRIC_REGISTRY[k].label}</option>`).join('');
        }
        function addMetricToConfig() { const v = document.getElementById('configAvailableMetrics').value; if(v) { if(currentMetricConfigContext === 'summary') summaryMetrics.push(v); else campaignMetrics.push(v); renderMetricConfigSelector(); } }
        function removeMetricFromConfig(k) { if(currentMetricConfigContext === 'summary') summaryMetrics = summaryMetrics.filter(m => m !== k); else campaignMetrics = campaignMetrics.filter(m => m !== k); renderMetricConfigSelector(); }
        function saveCurrentMetricConfig() { if(currentMetricConfigContext === 'summary') { localStorage.setItem('ads_summary_metrics', JSON.stringify(summaryMetrics)); } else { localStorage.setItem('ads_campaign_metrics', JSON.stringify(campaignMetrics)); } refreshData(); closeMetricConfigModal(); Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false}); }

        // --- BUDGET HELPERS ---
        function setBudgetMode(mode) {
            budgetState.mode = mode;
            const btnInc = document.getElementById('btnIncrease'); const btnDec = document.getElementById('btnDecrease');
            const activeClass = "border-green-500 bg-green-50 text-green-700 dark:bg-green-900/30 dark:text-green-400 dark:border-green-800";
            const inactiveClass = "border-transparent bg-slate-100 text-slate-500 dark:bg-slate-800 dark:text-slate-400";
            const decActiveClass = "border-red-500 bg-red-50 text-red-700 dark:bg-red-900/30 dark:text-red-400 dark:border-red-800";
            if (mode === 'increase') { btnInc.className = `flex-1 py-3 rounded-xl border font-bold text-xs h-12 flex items-center justify-center gap-2 transition ${activeClass}`; btnDec.className = `flex-1 py-3 rounded-xl border font-bold text-xs h-12 flex items-center justify-center gap-2 transition ${inactiveClass}`; } 
            else { btnInc.className = `flex-1 py-3 rounded-xl border font-bold text-xs h-12 flex items-center justify-center gap-2 transition ${inactiveClass}`; btnDec.className = `flex-1 py-3 rounded-xl border font-bold text-xs h-12 flex items-center justify-center gap-2 transition ${decActiveClass}`; }
            calculatePreview();
        }
        function setBudgetType(type) {
            budgetState.calcType = type;
            const btnFixed = document.getElementById('btnTypeFixed'); const btnPercent = document.getElementById('btnTypePercent');
            const input = document.getElementById('budgetInput');
            const active = "bg-white dark:bg-slate-700 text-slate-900 dark:text-white shadow-sm"; const inactive = "text-slate-500 dark:text-slate-400 hover:text-slate-700";
            if (type === 'fixed') { btnFixed.className = `flex-1 py-2 rounded-lg text-xs font-bold transition ${active}`; btnPercent.className = `flex-1 py-2 rounded-lg text-xs font-bold transition ${inactive}`; document.getElementById('inputPrefix').style.display = 'block'; document.getElementById('inputSuffix').style.display = 'none'; input.classList.add('pl-12'); input.classList.remove('pr-12'); } 
            else { btnFixed.className = `flex-1 py-2 rounded-lg text-xs font-bold transition ${inactive}`; btnPercent.className = `flex-1 py-2 rounded-lg text-xs font-bold transition ${active}`; document.getElementById('inputPrefix').style.display = 'none'; document.getElementById('inputSuffix').style.display = 'block'; input.classList.remove('pl-12'); input.classList.add('pr-12'); }
            calculatePreview();
        }
        function calculatePreview() {
            const inputVal = parseFloat(document.getElementById('budgetInput').value) || 0;
            let newBudget = 0; let changeAmount = 0;
            if (budgetState.calcType === 'fixed') { changeAmount = inputVal; if (budgetState.mode === 'increase') newBudget = budgetState.currentAmount + changeAmount; else newBudget = budgetState.currentAmount - changeAmount; } 
            else { const percentage = inputVal; if (budgetState.mode === 'increase') newBudget = budgetState.currentAmount * (1 + percentage / 100); else newBudget = budgetState.currentAmount * (1 - percentage / 100); changeAmount = Math.abs(newBudget - budgetState.currentAmount); }
            const finalBudget = Math.round(newBudget);
            const isIncrease = budgetState.mode === 'increase';
            const colorClass = isIncrease ? "font-bold text-green-600 dark:text-green-400" : "font-bold text-red-600 dark:text-red-400";
            let changeText = `${isIncrease ? '+' : '-'} ${formatIDR(changeAmount)}`; if (budgetState.calcType === 'percent') changeText += ` (${inputVal}%)`;
            document.getElementById('previewChange').innerText = changeText; document.getElementById('previewChange').className = `text-[10px] ${colorClass}`;
            if (finalBudget < 0) { document.getElementById('previewNewBudget').innerText = "Tidak Valid"; return 0; }
            document.getElementById('previewNewBudget').innerText = formatIDR(finalBudget);
            return finalBudget;
        }
        async function confirmBudgetUpdate() {
            const newBudget = calculatePreview(); const inputVal = parseFloat(document.getElementById('budgetInput').value);
            if (!inputVal || inputVal <= 0) { Swal.fire({ icon: 'warning', title: 'Input Tidak Valid', text: 'Masukkan jumlah perubahan budget.' }); return; }
            const result = await Swal.fire({ title: 'Konfirmasi', html: `Ubah budget menjadi <b>${formatIDR(newBudget)}</b>?`, icon: 'question', showCancelButton: true, confirmButtonText: 'Ya, Ubah', cancelButtonText: 'Batal', confirmButtonColor: '#2563EB' });
            if (result.isConfirmed) executeBudgetUpdate(newBudget);
        }

        // Modified to support both UI and Auto calls
        async function executeBudgetUpdate(newAmount) {
            closeBudgetModal();
            return apiUpdateBudget(budgetState.campaignId, newAmount, budgetState.type, true); // true = show UI
        }

        async function apiUpdateBudget(id, amount, type, showUI) {
            if (!currentAccountId) { 
                if (showUI) Swal.fire({ title: 'Mode Demo', text: 'Budget diperbarui (Simulasi).', icon: 'success', timer: 1500 }); 
                const c = currentCampaignData.find(x => x.id === id); 
                if (c) c.budget = amount; 
                processDataAndUI(currentCampaignData); 
                return true; 
            }
            try { 
                if (showUI) Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() }); 
                const fieldName = type === 'lifetime' ? 'lifetime_budget' : 'daily_budget'; 
                const payload = {}; payload[fieldName] = Math.round(amount); 
                const url = `https://graph.facebook.com/${CONFIG.apiVersion}/${id}?access_token=${CONFIG.accessToken}`; 
                const res = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); 
                const json = await res.json(); 
                if (json.error) throw new Error(json.error.message); 
                if (showUI) Swal.fire({ icon: 'success', title: 'Berhasil', text: 'Budget diperbarui.', timer: 2000 }); 
                refreshData(); 
                return true;
            } catch (error) { 
                console.error(error); 
                if (showUI) Swal.fire({ icon: 'error', title: 'Gagal Update', text: error.message }); 
                throw error;
            }
        }

        async function toggleCampaignStatus(id, isActive) {
            if (!currentAccountId) { Swal.fire({ title: 'Mode Demo', text: `Simulasi: Status diubah ke ${isActive ? 'ACTIVE' : 'PAUSED'}`, timer: 1000, icon: 'success' }); const c = currentCampaignData.find(x => x.id === id); if(c) c.status = isActive ? 'ACTIVE' : 'PAUSED'; return; }
            try { Swal.fire({ title: 'Menyimpan...', didOpen: () => Swal.showLoading() }); const url = `https://graph.facebook.com/${CONFIG.apiVersion}/${id}?access_token=${CONFIG.accessToken}`; const res = await fetch(url, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ status: isActive ? 'ACTIVE' : 'PAUSED' }) }); const json = await res.json(); if (json.error) throw new Error(json.error.message); Swal.fire({ icon: 'success', title: 'Berhasil', timer: 1000, showConfirmButton: false }); const c = currentCampaignData.find(x => x.id === id); if(c) c.status = isActive ? 'ACTIVE' : 'PAUSED'; } catch (error) { console.error(error); refreshData(); Swal.fire({ icon: 'error', title: 'Gagal', text: error.message }); }
        }

        // --- CALENDAR & DATE LOGIC ---
        function renderQuickDateOptions() { document.getElementById('quickDateGrid').innerHTML = QUICK_DATE_OPTIONS.map(o => `<button onclick="applyPreset('${o.id}', '${o.label}')" class="p-3 border border-slate-200 dark:border-slate-800 rounded-xl text-xs font-bold text-center bg-slate-50 dark:bg-slate-800/50 hover:bg-teal-50 dark:hover:bg-teal-900/20 hover:border-teal-200 dark:hover:border-teal-800 transition text-slate-600 dark:text-slate-300">${o.label}</button>`).join(''); }
        function applyPreset(id, label) { CONFIG.datePreset = id; customDateRange = {start:null, end:null}; document.getElementById('activeDateLabel').innerText = label; applyDateFilter(); }
        function renderCalendarUI() { const container = document.getElementById('yearCalendarContainer'); if(!container) return; container.innerHTML = ''; const months = ['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des']; const year = new Date().getFullYear(); let html = ''; months.forEach((m, idx) => { let d = new Date(year, idx+1, 0).getDate(); let startDay = new Date(year, idx, 1).getDay(); html += `<div class="mb-5"><div class="font-bold text-xs mb-3 pl-1 text-slate-900 dark:text-white uppercase tracking-wider">${m} ${year}</div><div class="grid grid-cols-7 gap-y-2 gap-x-1 text-center">`; for(let i=0; i<startDay; i++) html += `<div></div>`; for(let i=1; i<=d; i++) { let classes = 'calendar-day'; if(customDateRange.start) { const t = new Date(year, idx, i).getTime(); if(t === customDateRange.start.getTime()) classes += ' range-start'; if(customDateRange.end && t === customDateRange.end.getTime()) classes += ' range-end'; if(customDateRange.end && t > customDateRange.start.getTime() && t < customDateRange.end.getTime()) classes += ' in-range'; } const isToday = new Date().toDateString() === new Date(year, idx, i).toDateString(); if(isToday) classes += ' today'; html += `<div class="${classes}" onclick="handleDateClick(${new Date(year, idx, i).getTime()})">${i}</div>`; } html += `</div></div>`; }); container.innerHTML = html; }
        function handleDateClick(timestamp) { const clicked = new Date(timestamp); clicked.setHours(0,0,0,0); if(!customDateRange.start || (customDateRange.start && customDateRange.end)) { customDateRange.start = clicked; customDateRange.end = null; } else { if(clicked < customDateRange.start) { customDateRange.end = customDateRange.start; customDateRange.start = clicked; } else { customDateRange.end = clicked; } } CONFIG.datePreset = null; renderQuickDateOptions(); renderCalendarUI(); const s = customDateRange.start; const e = customDateRange.end || s; const fmt = d => `${d.getDate()} ${['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'][d.getMonth()]}`; document.getElementById('manualDateDisplay').innerText = `${fmt(s)} - ${fmt(e)}`; }
        function applyDateFilter() { if(customDateRange.start) { const s = customDateRange.start; const e = customDateRange.end || s; const fmt = d => `${d.getDate()} ${['Jan','Feb','Mar','Apr','Mei','Jun','Jul','Agt','Sep','Okt','Nov','Des'][d.getMonth()]}`; document.getElementById('activeDateLabel').innerText = `${fmt(s)} - ${fmt(e)}`; } refreshData(); closeDateRangeModal(); }

        // --- RULE ENGINE: SCHEDULER & EXECUTION ---
        function renderRulesAccountSelector() {
            const select = document.getElementById('rulesAccountFilter'); const createBtn = document.getElementById('btnOpenCreateRule'); if(!select) return;
            select.innerHTML = '';
            if (accounts.length === 0) { select.innerHTML = '<option value="">Belum ada akun</option>'; select.disabled = true; if(createBtn) createBtn.disabled = true; return; }
            select.disabled = false; if(createBtn) createBtn.disabled = false;
            accounts.forEach(acc => { const opt = document.createElement('option'); opt.value = acc.id; opt.text = acc.name; select.appendChild(opt); });
            if(currentAccountId && accounts.some(a => a.id === currentAccountId)) select.value = currentAccountId; else select.value = accounts[0].id;
        }

        function renderRulesTable() {
             const tbody = document.getElementById('rulesTableBody'); if(!tbody) return;
             const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]');
             const filterSelect = document.getElementById('rulesAccountFilter'); const selectedAccountId = filterSelect ? filterSelect.value : currentAccountId;
             
             if(accounts.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="text-center py-12 text-sm text-slate-400">Hubungkan akun iklan terlebih dahulu.</td></tr>`; return; }
             const filteredRules = rules.filter(r => r.adAccountId === selectedAccountId);
             tbody.innerHTML = filteredRules.length ? '' : '<tr><td colspan="5" class="text-center py-12 text-sm text-slate-400">Belum ada aturan aktif.</td></tr>';
             
             filteredRules.forEach(r => { 
                 const isActive = r.isActive !== false;
                 // Get latest log
                 const ruleLogs = automatedRulesHistory.filter(l => l.ruleId === r.id || l.ruleName === r.name).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
                 const latestLog = ruleLogs[0];
                 
                 let logContent = '<span class="text-slate-400 text-xs italic">Belum ada data</span>';
                 let statusExtra = ''; 

                 if(r.status === 'Error') {
                     statusExtra = `<span class="ml-2 px-1.5 py-0.5 bg-red-100 text-red-600 text-[10px] font-bold rounded">Error</span>`;
                 }

                 if(latestLog) {
                     const time = new Date(latestLog.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'});
                     const resultText = latestLog.result; 
                     let resultColor = 'border-slate-200 text-slate-500';
                     
                     if (resultText === 'Success') resultColor = 'text-green-600 bg-green-50 border-green-200 dark:bg-green-900/20 dark:text-green-400';
                     else if (resultText === 'Failed') resultColor = 'text-red-600 bg-red-50 border-red-200';
                     else if (resultText === 'Skipped') resultColor = 'text-slate-500 bg-slate-100 border-slate-200 dark:bg-slate-800 dark:text-slate-400';

                     const summary = latestLog.summary || latestLog.action.replace(/_/g, ' ');
                     logContent = `<div onclick="viewRuleLogs(${r.id})" class="cursor-pointer group"><div class="flex items-center gap-2 mb-1"><span class="font-mono text-[10px] text-slate-500">${time}</span><span class="text-[9px] px-1.5 rounded border ${resultColor} font-bold uppercase">${resultText}</span></div><p class="text-xs font-bold text-slate-700 dark:text-slate-300 truncate max-w-[180px]">${summary}</p></div>`;
                 }

                 let targetBadgeClass = 'bg-slate-100 text-slate-600 dark:bg-slate-800 dark:text-slate-300';
                 if(r.target === 'campaign') targetBadgeClass = 'bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-400';
                 else if(r.target === 'adset') targetBadgeClass = 'bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-400';
                 else if(r.target === 'ad') targetBadgeClass = 'bg-orange-50 text-orange-600 dark:bg-orange-900/20 dark:text-orange-400';

                 tbody.innerHTML += `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/30 transition border-b border-slate-100 dark:border-slate-800/50 last:border-0">
                    <td class="align-middle"><span class="px-2 py-1 rounded text-[10px] font-bold uppercase ${targetBadgeClass}">${r.target}</span></td>
                    <td><div class="font-bold text-slate-800 dark:text-slate-200 text-sm truncate max-w-[140px]">${r.name}</div></td>
                    <td class="align-middle"><div class="flex items-center"><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleRuleStatus(${r.id}, this.checked)" ${isActive ? 'checked' : ''}><div class="w-10 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer dark:bg-slate-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-500"></div></label>${statusExtra}</div></td>
                    <td>${logContent}</td>
                    <td class="text-center"><div class="flex items-center justify-center gap-2"><button onclick="runSingleRule(${r.id})" class="w-9 h-9 flex items-center justify-center rounded-xl bg-blue-50 text-blue-600 hover:bg-blue-100 dark:bg-blue-900/20 dark:text-blue-400 dark:hover:bg-blue-900/40 transition" ${!isActive ? 'disabled' : ''}><i class="fa-solid fa-play text-xs"></i></button><button onclick="editRule(${r.id})" class="w-9 h-9 flex items-center justify-center rounded-xl bg-slate-100 text-slate-600 hover:bg-slate-200 dark:bg-slate-800 dark:text-slate-400 dark:hover:bg-slate-700 transition"><i class="fa-solid fa-pencil text-xs"></i></button><button onclick="deleteRule(${r.id})" class="w-9 h-9 flex items-center justify-center rounded-xl bg-red-50 text-red-600 hover:bg-red-100 dark:bg-red-900/20 dark:text-red-400 transition"><i class="fa-solid fa-trash text-xs"></i></button></div></td>
                 </tr>`; 
             });
        }

        async function runAutomatedRules() {
            const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]');
            const now = Date.now();
            let updatedRules = [...rules];
            let hasUpdates = false;
            const activeRules = rules.filter(r => r.isActive !== false);
            
            if (!activeRules.length) return;

            for (const rule of activeRules) {
                const lastRun = rule.lastExecutedAt ? new Date(rule.lastExecutedAt).getTime() : 0;
                
                // --- CUSTOM SCHEDULE CHECK LOGIC ---
                if (rule.scheduleType === 'custom') {
                    if (!rule.customTimes || rule.customTimes.length === 0) continue; 
                    
                    const nowObj = new Date();
                    
                    let isTriggerTime = false;
                    
                    for (const t of rule.customTimes) {
                        // Format t: "YYYY-MM-DD HH:MM"
                        const targetDate = new Date(t);
                        const diffMs = nowObj.getTime() - targetDate.getTime();
                        const diffMins = Math.abs(diffMs / 60000);
                        
                        // Rule: Within 5 min window AND not yet executed for this specific slot
                        if (diffMins <= 5) {
                            if (nowObj.getTime() - lastRun > 300000) { 
                                isTriggerTime = true;
                                break;
                            }
                        }
                    }
                    if (!isTriggerTime) continue; 
                } else {
                    // Continuous / Daily logic
                    if (now - lastRun < SCHEDULER_CONFIG.interval) continue; 
                }

                if (rule.executionLock && (now - rule.executionLock < SCHEDULER_CONFIG.lockDuration)) continue;

                const ruleIndex = updatedRules.findIndex(r => r.id === rule.id);
                if(ruleIndex !== -1) {
                    updatedRules[ruleIndex].executionLock = now;
                    hasUpdates = true;
                }
                localStorage.setItem('ads_rules', JSON.stringify(updatedRules)); 

                try {
                    let ruleTriggered = false;
                    let targetEntities = [];

                    if (rule.target === 'campaign') { targetEntities = currentCampaignData || []; } 
                    else if (rule.target === 'adset') { targetEntities = currentAdSetData || []; } 
                    else if (rule.target === 'ad') { targetEntities = currentAdData || []; }

                    if (targetEntities.length === 0) {
                         saveRuleLog({
                            id: Date.now() + Math.random(),
                            timestamp: new Date().toISOString(),
                            ruleId: rule.id,
                            ruleName: rule.name,
                            targetLevel: rule.target,
                            entityId: '-',
                            assetName: '-',
                            action: rule.action,
                            summary: `Skipped: No data for ${rule.target}`,
                            result: 'Skipped',
                            adAccountId: currentAccountId
                        });
                    } else {
                        for (const entity of targetEntities) {
                            if (evaluateRuleConditions(rule, entity)) {
                                ruleTriggered = true;
                                
                                const executionResult = await executeRuleAction(rule, entity);
                                
                                let summaryText = getActionSummary(rule);
                                if (executionResult && executionResult.note) {
                                    summaryText += executionResult.note;
                                }

                                saveRuleLog({
                                    id: Date.now() + Math.random(),
                                    timestamp: new Date().toISOString(),
                                    ruleId: rule.id,
                                    ruleName: rule.name,
                                    targetLevel: rule.target,
                                    entityId: entity.id,
                                    assetName: entity.name,
                                    action: rule.action,
                                    summary: summaryText,
                                    result: 'Success',
                                    adAccountId: currentAccountId
                                });
                            }
                        }

                        if (!ruleTriggered) {
                            saveRuleLog({
                                id: Date.now() + Math.random(),
                                timestamp: new Date().toISOString(),
                                ruleId: rule.id,
                                ruleName: rule.name,
                                targetLevel: rule.target,
                                entityId: '-',
                                assetName: '-',
                                action: rule.action,
                                summary: 'Skipped: Conditions not met',
                                result: 'Skipped',
                                adAccountId: currentAccountId
                            });
                        }
                    }

                    if(ruleIndex !== -1) {
                        updatedRules[ruleIndex].lastExecutedAt = new Date().toISOString();
                        updatedRules[ruleIndex].status = 'Active';
                        updatedRules[ruleIndex].executionLock = null; 
                        hasUpdates = true;
                    }

                } catch (error) {
                    console.error(`Rule ${rule.name} failed:`, error);
                    if(ruleIndex !== -1) {
                        updatedRules[ruleIndex].status = 'Error';
                        updatedRules[ruleIndex].executionLock = null;
                        hasUpdates = true;
                    }
                    saveRuleLog({
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        ruleId: rule.id,
                        ruleName: rule.name,
                        targetLevel: rule.target,
                        assetName: 'System',
                        action: rule.action,
                        summary: 'Failed: ' + error.message,
                        result: 'Failed',
                        adAccountId: currentAccountId
                    });
                }
            }

            if(hasUpdates) {
                localStorage.setItem('ads_rules', JSON.stringify(updatedRules));
                renderRulesTable();
            }
        }

        function evaluateRuleConditions(rule, entity) {
            if (!rule.conditions || rule.conditions.length === 0) return false;
            for (const cond of rule.conditions) {
                let actualVal = 0, targetVal = parseFloat(cond.v);
                if (cond.type === 'TEXT') { 
                    const val = (entity.name || '').toLowerCase(); 
                    const t = (cond.v || '').toLowerCase();
                    if (cond.op === 'contains' && !val.includes(t)) return false;
                    if (cond.op === 'not_contains' && val.includes(t)) return false;
                } else {
                    const k = Object.keys(METRIC_REGISTRY).find(k => METRIC_REGISTRY[k].label === cond.m); 
                    if (!k || entity[k] === undefined) { console.warn(`Metric ${cond.m} not found on entity ${entity.id}`); return false; }
                    actualVal = parseFloat(entity[k]) || 0;
                    if (cond.op === 'greater' && actualVal <= targetVal) return false;
                    if (cond.op === 'smaller' && actualVal >= targetVal) return false;
                    if (cond.op === 'equal' && actualVal !== targetVal) return false;
                }
            }
            return true;
        }

        async function executeRuleAction(rule, entity) {
            if(rule.action === 'turn_off' && entity.status === 'ACTIVE') { 
                await toggleCampaignStatus(entity.id, false); 
                return { note: '' };
            }
            else if(rule.action === 'turn_on' && entity.status === 'PAUSED') {
                await toggleCampaignStatus(entity.id, true);
                return { note: '' };
            }
            else if (['increase_budget', 'decrease_budget', 'reset_budget'].includes(rule.action)) {
                return await executeAutomatedBudget(entity, rule);
            }
            return null;
        }

        async function executeAutomatedBudget(entity, rule) {
             if (rule.target === 'ad') throw new Error("Budget actions not supported for Ads.");
             
             const cur = parseFloat(entity.budget || entity.daily_budget || entity.lifetime_budget || 0); 
             let neu = cur; 
             const val = parseFloat(rule.actionValue)||0; 
             const unit = rule.actionUnit;
             const limit = parseFloat(rule.budgetLimit) || 0;
             let note = "";

             if (rule.action === 'reset_budget') {
                 neu = val;
             } else if (rule.action === 'increase_budget') {
                 neu = unit === 'percent' ? cur * (1 + val / 100) : cur + val;
                 if (limit > 0 && neu > limit) {
                     neu = limit;
                     note = ` [Max ${formatIDR(limit)}]`;
                 }
             } else if (rule.action === 'decrease_budget') {
                 neu = unit === 'percent' ? cur * (1 - val / 100) : cur - val;
                 if (limit > 0 && neu < limit) {
                     neu = limit;
                     note = ` [Min ${formatIDR(limit)}]`;
                 }
             }
             
             neu = Math.max(0, Math.round(neu));
             
             if (neu !== cur) { 
                 budgetState.campaignId = entity.id; 
                 budgetState.type = entity.budget_type || 'daily'; 
                 // Execute silently (showUI = false)
                 await apiUpdateBudget(entity.id, neu, entity.budget_type || 'daily', false);
                 return {
                     old: cur,
                     new: neu,
                     note: note
                 };
             }
             return null;
        }

        function getActionSummary(rule) {
            if(rule.action === 'turn_off') return 'Matikan Aset';
            if(rule.action === 'turn_on') return 'Nyalakan Aset';
            const val = rule.actionValue || 0; const unit = rule.actionUnit === 'percent' ? '%' : ' IDR';
            const sign = rule.action.includes('increase') ? '+' : (rule.action.includes('decrease') ? '-' : '=');
            return `Budget ${sign}${val}${unit}`;
        }

        function handleTargetChange() {
            const target = document.getElementById('crTarget').value;
            const actionSelect = document.getElementById('crAction');
            const optBudget = document.getElementById('optBudget');
            if(target === 'ad') {
                const currentVal = actionSelect.value;
                if(['increase_budget', 'decrease_budget', 'reset_budget'].includes(currentVal)) {
                    actionSelect.value = "";
                    handleActionChange();
                }
                optBudget.disabled = true;
            } else { optBudget.disabled = false; }
        }

        function handleActionChange() {
            const action = document.getElementById('crAction').value;
            const container = document.getElementById('actionValueContainer');
            const limitContainer = document.getElementById('budgetLimitContainer');
            const limitLabel = document.getElementById('budgetLimitLabel');
            const limitHelp = document.getElementById('budgetLimitHelpText');

            if(['increase_budget', 'decrease_budget', 'reset_budget'].includes(action)) {
                container.classList.remove('hidden');
                
                // Reset/Default logic
                if(action === 'reset_budget') {
                    document.getElementById('actionValueLabel').innerText = 'Nominal Reset (IDR)';
                    document.getElementById('crActionUnit').classList.add('hidden'); document.getElementById('crActionUnit').value = 'currency';
                    limitContainer.classList.add('hidden');
                } else {
                    document.getElementById('actionValueLabel').innerText = 'Nilai Penyesuaian';
                    document.getElementById('crActionUnit').classList.remove('hidden');
                    
                    // Show Limit Card based on action
                    limitContainer.classList.remove('hidden');
                    if (action === 'increase_budget') {
                        limitLabel.innerText = 'Anggaran Harian Maksimum';
                        limitHelp.innerText = 'Budget tidak akan dinaikkan melebihi nilai ini.';
                    } else {
                        limitLabel.innerText = 'Anggaran Harian Minimum';
                        limitHelp.innerText = 'Budget tidak akan diturunkan di bawah nilai ini.';
                    }
                }
            } else { 
                container.classList.add('hidden'); 
                limitContainer.classList.add('hidden');
            }
            validateRuleConfig();
        }
        function validateRuleConfig() {
            const action = document.getElementById('crAction').value; const btn = document.getElementById('btnSaveRule');
            const isValid = action && currentRuleConditions.length > 0;
            btn.disabled = !isValid; if(isValid) btn.classList.remove('opacity-50'); else btn.classList.add('opacity-50');
        }
        function toggleConditionMenu() { const menu = document.getElementById('conditionMenu'); if(menu.classList.contains('hidden')) { renderConditionMenu(); menu.classList.remove('hidden'); } else { menu.classList.add('hidden'); } }
        function selectMetric(name, type) {
             document.getElementById('selectedMetricLabel').innerText = name; document.getElementById('crMetric').value = name; document.getElementById('crMetricType').value = type;
             document.getElementById('conditionMenu').classList.add('hidden');
             const opSelect = document.getElementById('crOperator'); const valInput = document.getElementById('crValue');
             if (type === 'TEXT') {
                 opSelect.innerHTML = `<option value="contains">Mengandung</option><option value="not_contains">Tidak Mengandung</option>`;
                 valInput.type = 'text'; valInput.placeholder = 'Teks...'; document.getElementById('crCurrencyLabel').style.display = 'none';
             } else {
                 opSelect.innerHTML = `<option value="greater">Lebih dari (>)</option><option value="smaller">Kurang dari (<)</option><option value="equal">Sama dengan (=)</option>`;
                 valInput.type = 'number'; valInput.placeholder = 'Nilai';
                 const isCurrency = ['Spent', 'Budget', 'Cost', 'CPA'].some(kw => name.includes(kw));
                 document.getElementById('crCurrencyLabel').style.display = isCurrency ? 'block' : 'none';
             }
        }
        
        // --- METRIC SELECTION WITH SEARCH ---
        function toggleConditionMenu() { 
            const menu = document.getElementById('conditionMenu'); 
            if(menu.classList.contains('hidden')) { 
                renderConditionMenu(); 
                menu.classList.remove('hidden'); 
            } else { 
                menu.classList.add('hidden'); 
            } 
        }

        function renderConditionMenu() {
            const menu = document.getElementById('conditionMenu');
            // Sticky Search Header + Content Container
            menu.innerHTML = `
                <div class="sticky top-0 bg-white dark:bg-slate-800 p-2 border-b border-slate-100 dark:border-slate-700 z-20">
                    <div class="relative">
                        <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs"></i>
                        <input type="text" id="metricSearchInput" oninput="filterMetrics(this.value)" placeholder="Cari metrik..." class="w-full pl-8 pr-3 py-2 text-xs rounded-lg border border-slate-200 dark:border-slate-700 bg-slate-50 dark:bg-slate-900 text-slate-700 dark:text-slate-200 focus:outline-none focus:border-blue-500 transition" autocomplete="off">
                    </div>
                </div>
                <div id="metricListContainer" class="p-2 space-y-1">
                    ${generateMetricListHTML('')}
                </div>
            `;
            // Auto focus search
            setTimeout(() => {
                const input = document.getElementById('metricSearchInput');
                if(input) input.focus();
            }, 100);
        }

        function filterMetrics(val) {
            const container = document.getElementById('metricListContainer');
            if(container) container.innerHTML = generateMetricListHTML(val);
        }

        function generateMetricListHTML(filterText) {
            const lowerFilter = filterText.toLowerCase();
            let html = '';
            let hasResults = false;
            
            for(const [cat, items] of Object.entries(RULE_CONDITIONS_MENU)) {
                const filteredItems = items.filter(i => i.label.toLowerCase().includes(lowerFilter));
                
                if (filteredItems.length > 0) {
                    hasResults = true;
                    html += `<div class="mb-2 last:mb-0">
                        <p class="text-[9px] font-black text-slate-400 uppercase px-2 py-1.5 tracking-wider">${cat}</p>
                        <div class="space-y-0.5">
                        ${filteredItems.map(i => `
                            <div class="text-xs p-2 hover:bg-blue-50 dark:hover:bg-blue-900/20 cursor-pointer rounded-lg text-slate-700 dark:text-slate-200 flex justify-between items-center group transition" onclick="selectMetric('${i.label}', '${i.type}')">
                                <span class="font-medium">${i.label}</span>
                                <span class="opacity-0 group-hover:opacity-100 transition text-[9px] px-1.5 py-0.5 bg-blue-100 dark:bg-blue-800 text-blue-600 dark:text-blue-200 rounded">${i.type === 'NUMBER' ? '123' : 'ABC'}</span>
                            </div>
                        `).join('')}
                        </div>
                    </div>`;
                }
            }
            
            if (!hasResults) {
                html = `<div class="text-center py-6 text-xs text-slate-400 italic">
                    <i class="fa-solid fa-circle-question mb-2 text-lg opacity-50"></i><br>
                    Tidak ditemukan metrik "${filterText}"
                </div>`;
            }
            
            return html;
        }

        function addConditionToRule() {
            const m = document.getElementById('crMetric').value; const v = document.getElementById('crValue').value; const op = document.getElementById('crOperator').value; const type = document.getElementById('crMetricType').value;
            if(m && v) { 
                if (editingConditionId) {
                    const idx = currentRuleConditions.findIndex(c => c.id === editingConditionId);
                    if (idx !== -1) currentRuleConditions[idx] = { id: editingConditionId, m, v, op, type };
                    editingConditionId = null;
                    document.getElementById('btnAddCondition').innerHTML = '<i class="fa-solid fa-plus"></i>';
                } else {
                    const id = Date.now(); currentRuleConditions.push({ id, m, v, op, type });
                }
                document.getElementById('crValue').value = ''; renderConditionsList(); validateRuleConfig();
            }
        }
        function editCondition(id) {
            const cond = currentRuleConditions.find(c => c.id === id);
            if (!cond) return;
            selectMetric(cond.m, cond.type);
            document.getElementById('crOperator').value = cond.op;
            document.getElementById('crValue').value = cond.v;
            editingConditionId = id;
            document.getElementById('btnAddCondition').innerHTML = '<i class="fa-solid fa-check"></i>';
        }
        function renderConditionsList() {
            document.getElementById('addedConditionsList').innerHTML = currentRuleConditions.map(c => `
                <div class="flex justify-between items-center p-3 border border-slate-200 dark:border-slate-700 rounded-xl bg-white dark:bg-slate-800">
                    <div class="text-sm text-slate-700 dark:text-slate-200"><span class="font-bold text-blue-600 dark:text-blue-400">${c.m}</span> ${c.op === 'greater' ? '>' : (c.op === 'smaller' ? '<' : c.op)} <span class="font-mono font-bold">${c.v}</span></div>
                    <div class="flex gap-2">
                        <button onclick="editCondition(${c.id})" class="text-slate-400 hover:text-blue-500 hover:bg-slate-100 dark:hover:bg-slate-700 rounded-lg p-1.5 transition"><i class="fa-solid fa-pencil"></i></button>
                        <button onclick="deleteCondition(${c.id})" class="text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg p-1.5"><i class="fa-solid fa-trash"></i></button>
                    </div>
                </div>`).join('');
        }
        function deleteCondition(id) { currentRuleConditions = currentRuleConditions.filter(c => c.id !== id); renderConditionsList(); validateRuleConfig(); }
        function clearAllConditions() { currentRuleConditions = []; renderConditionsList(); validateRuleConfig(); }

        // --- RULE SCHEDULE LOGIC (CUSTOM) ---
        function toggleCustomSchedule() {
            const radios = document.getElementsByName('ruleSchedule');
            const customContainer = document.getElementById('customScheduleContainer');
            let isCustom = false;
            for(let i=0; i<radios.length; i++) { if(radios[i].checked && radios[i].value === 'custom') isCustom = true; }
            if(isCustom) {
                customContainer.classList.remove('hidden');
                if(customContainer.children.length === 0) renderCustomSchedule(customContainer);
            } else { customContainer.classList.add('hidden'); }
        }
        
        function renderCustomSchedule(container) {
            container.innerHTML = `
                <div class="space-y-4">
                    <div class="flex gap-3">
                        <div class="relative flex-1 group">
                            <div class="absolute inset-0 flex items-center pl-4 border border-slate-300 dark:border-slate-700 rounded-xl pointer-events-none group-hover:border-blue-500 transition bg-white dark:bg-slate-800">
                                <i class="fa-solid fa-calendar-days text-slate-400 group-hover:text-blue-500 transition mr-3"></i>
                                <span class="text-sm text-slate-400">Pilih Tanggal</span>
                            </div>
                            <input type="date" id="customDateInput" class="opacity-0 w-full h-12 cursor-pointer z-10 relative">
                        </div>
                        <div class="relative w-32 group">
                            <div class="absolute inset-0 flex items-center pl-4 border border-slate-300 dark:border-slate-700 rounded-xl pointer-events-none group-hover:border-blue-500 transition bg-white dark:bg-slate-800">
                                <i class="fa-solid fa-clock text-slate-400 group-hover:text-blue-500 transition"></i>
                            </div>
                            <input type="time" id="customTimeInput" class="opacity-0 w-full h-12 cursor-pointer z-10 relative">
                        </div>
                        <button onclick="addCustomTime()" class="w-12 h-12 bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-lg shadow-blue-500/30 transition flex items-center justify-center shrink-0 active:scale-95">
                            <i class="fa-solid fa-plus text-sm"></i>
                        </button>
                    </div>
                    
                    <div id="selectedTimesContainer" class="space-y-2"></div>
                    
                    <div class="p-3 bg-blue-50 dark:bg-blue-900/10 rounded-xl border border-blue-100 dark:border-blue-900/30">
                        <p class="text-[10px] font-bold text-blue-600 dark:text-blue-300 uppercase mb-2">Preview Eksekusi</p>
                        <div id="schedulePreview" class="text-xs text-slate-600 dark:text-slate-400 space-y-1 font-mono">
                            Belum ada jadwal.
                        </div>
                    </div>
                </div>
            `;
            
            // Add listeners to update the visual "placeholder" when value changes
            setTimeout(() => {
                const dateIn = document.getElementById('customDateInput');
                const timeIn = document.getElementById('customTimeInput');
                
                if(dateIn) dateIn.addEventListener('change', (e) => {
                    const display = e.target.parentElement.querySelector('span');
                    if(display) {
                        display.innerText = e.target.value ? new Date(e.target.value).toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric'}) : 'Pilih Tanggal';
                        display.classList.toggle('text-slate-900', !!e.target.value);
                        display.classList.toggle('dark:text-white', !!e.target.value);
                    }
                });
                
                if(timeIn) timeIn.addEventListener('change', (e) => {
                    // Visual feedback for time is tricky with just icon, so we rely on picker
                });
            }, 100);
            
            renderCustomTimeList();
        }

        function addCustomTime() {
            const dateInput = document.getElementById('customDateInput');
            const timeInput = document.getElementById('customTimeInput');
            const dateVal = dateInput.value;
            const timeVal = timeInput.value;
            
            if(!dateVal || !timeVal) {
                 Swal.fire({icon: 'warning', text: 'Tanggal dan Jam harus diisi.', timer: 1500, showConfirmButton: false});
                 return;
            }

            const dateTimeStr = `${dateVal} ${timeVal}`; // YYYY-MM-DD HH:MM
            const selectedDate = new Date(dateTimeStr);
            const now = new Date();

            if (selectedDate < now) {
                Swal.fire({icon: 'error', title: 'Waktu Invalid', text: 'Jadwal tidak boleh di masa lalu.'});
                return;
            }
            
            if(currentRuleCustomTimes.includes(dateTimeStr)) {
                Swal.fire({icon: 'warning', text: 'Jadwal ini sudah ada.', timer: 1500, showConfirmButton: false});
                return;
            }
            
            currentRuleCustomTimes.push(dateTimeStr);
            currentRuleCustomTimes.sort(); // Sort chronologically
            renderCustomTimeList();
            
            // Reset inputs visually
            dateInput.value = '';
            timeInput.value = '';
            const display = dateInput.parentElement.querySelector('span');
            if(display) {
                display.innerText = 'Pilih Tanggal';
                display.classList.remove('text-slate-900', 'dark:text-white');
            }
        }

        function removeCustomTime(index) {
            currentRuleCustomTimes.splice(index, 1);
            renderCustomTimeList();
        }

        function renderCustomTimeList() {
            const container = document.getElementById('selectedTimesContainer');
            const preview = document.getElementById('schedulePreview');
            if(!container) return;
            
            container.innerHTML = currentRuleCustomTimes.map((t, idx) => {
                const d = new Date(t);
                const dateFmt = d.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric'});
                const timeFmt = d.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                
                return `
                <div class="flex items-center justify-between bg-white dark:bg-slate-800 p-3 rounded-xl border border-slate-200 dark:border-slate-700 shadow-sm group hover:border-blue-300 dark:hover:border-blue-700 transition">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-lg bg-slate-100 dark:bg-slate-700 flex items-center justify-center text-slate-500 dark:text-slate-300 font-bold text-xs">
                            ${idx + 1}
                        </div>
                        <div>
                            <p class="text-xs font-bold text-slate-900 dark:text-white">${dateFmt}</p>
                            <p class="text-[10px] text-slate-500 font-mono mt-0.5">${timeFmt}</p>
                        </div>
                    </div>
                    <button onclick="removeCustomTime(${idx})" class="text-slate-400 hover:text-red-500 p-2 transition"><i class="fa-solid fa-trash-can"></i></button>
                </div>
            `}).join('');
            
            if(currentRuleCustomTimes.length > 0) {
                const next = new Date(currentRuleCustomTimes[0]);
                const now = new Date();
                const diffMs = next - now;
                const diffHrs = Math.floor(diffMs / 3600000);
                const diffMins = Math.floor((diffMs % 3600000) / 60000);
                
                let timeStr = "";
                if (diffHrs > 0) timeStr += `${diffHrs} jam `;
                timeStr += `${diffMins} menit`;
                
                preview.innerHTML = `
                    <div class="flex justify-between items-center">
                        <span>Eksekusi berikutnya:</span>
                        <span class="text-blue-600 dark:text-blue-400 font-bold">${currentRuleCustomTimes[0]}</span>
                    </div>
                    <div class="text-[10px] text-slate-400 mt-1">Estimasi: ${diffMs > 0 ? 'Dalam ' + timeStr : 'Segera/Terlewat'}</div>
                `;
            } else {
                preview.innerText = 'Belum ada jadwal yang dipilih.';
            }
        }

        // --- RULE ACTIONS ---
        function runSingleRule(id) {
            Swal.fire({ title: 'Jalankan?', text: "Eksekusi aturan ini sekarang.", icon: 'question', showCancelButton: true, confirmButtonText: 'Jalankan' }).then((result) => {
                if (result.isConfirmed) { refreshData().then(() => { runAutomatedRules(); Swal.fire('Selesai', 'Aturan dijalankan.', 'success'); }); }
            });
        }
        function toggleRuleStatus(id, isActive) { const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]'); const idx = rules.findIndex(r => r.id === id); if(idx !== -1) { rules[idx].isActive = isActive; localStorage.setItem('ads_rules', JSON.stringify(rules)); renderRulesTable(); } }
        function editRule(id) {
            const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]'); const rule = rules.find(r => r.id === id); if(!rule) return;
            editingRuleId = id;
            document.getElementById('createRuleModalTitle').innerText = 'Edit Aturan'; document.getElementById('btnSaveRule').innerText = 'Update Aturan';
            document.getElementById('crName').value = rule.name; 
            document.getElementById('crTarget').value = rule.target || 'campaign'; 
            
            handleTargetChange(); 
            
            document.getElementById('crAction').value = rule.action;
            if(rule.actionValue) document.getElementById('crActionValue').value = rule.actionValue;
            if(rule.actionUnit) document.getElementById('crActionUnit').value = rule.actionUnit;
            if(rule.budgetLimit) document.getElementById('crBudgetLimit').value = rule.budgetLimit;
            
            const radios = document.getElementsByName('ruleSchedule');
            const schedType = rule.scheduleType || 'continuous';
            for(let i=0; i<radios.length; i++) { if(radios[i].value === schedType) radios[i].checked = true; }
            
            // Load Custom Times
            currentRuleCustomTimes = rule.customTimes || [];
            toggleCustomSchedule(); // Will re-render and populate

            handleActionChange(); currentRuleConditions = rule.conditions || []; renderConditionsList(); validateRuleConfig();
            openModal('createRuleModal', 'createRuleModalContent');
        }
        function saveRule() {
            const name = document.getElementById('crName').value; const action = document.getElementById('crAction').value; const target = document.getElementById('crTarget').value;
            const filterSelect = document.getElementById('rulesAccountFilter'); const targetAccountId = filterSelect ? filterSelect.value : currentAccountId;
            if(!targetAccountId) { Swal.fire({icon: 'error', text: 'Pilih akun iklan dulu.'}); return; }
            
            let scheduleType = 'continuous';
            const radios = document.getElementsByName('ruleSchedule');
            for(let i=0; i<radios.length; i++) { if(radios[i].checked) scheduleType = radios[i].value; }

            // Validate Custom Schedule
            if (scheduleType === 'custom' && currentRuleCustomTimes.length === 0) {
                Swal.fire({icon: 'warning', text: 'Pilih minimal satu waktu eksekusi.'});
                return;
            }

            const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]');
            const ruleData = { 
                name, target, conditions: currentRuleConditions, action, 
                actionValue: document.getElementById('crActionValue').value, 
                actionUnit: document.getElementById('crActionUnit').value,
                budgetLimit: document.getElementById('crBudgetLimit').value,
                adAccountId: targetAccountId,
                scheduleType: scheduleType,
                customTimes: currentRuleCustomTimes
            };
            if (editingRuleId) { const idx = rules.findIndex(r => r.id === editingRuleId); if (idx !== -1) rules[idx] = { ...rules[idx], ...ruleData }; } 
            else { rules.push({ id: Date.now(), ...ruleData, isActive: true }); }
            localStorage.setItem('ads_rules', JSON.stringify(rules)); 
            closeCreateRuleModal(); renderRulesTable();
            Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false});
        }
        function deleteRule(id) { Swal.fire({ title: 'Hapus?', icon: 'warning', showCancelButton: true, confirmButtonColor: '#ef4444', confirmButtonText: 'Ya, Hapus' }).then((result) => { if(result.isConfirmed) { const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]'); localStorage.setItem('ads_rules', JSON.stringify(rules.filter(r => r.id !== id))); renderRulesTable(); } }); }
        
        function saveRuleLog(entry) { automatedRulesHistory.push(entry); if(automatedRulesHistory.length > 100) automatedRulesHistory = automatedRulesHistory.slice(-100); localStorage.setItem('ads_rules_history', JSON.stringify(automatedRulesHistory)); renderRulesTable(); }
        
        function viewRuleLogs(ruleId) {
            const rules = JSON.parse(localStorage.getItem('ads_rules') || '[]'); const rule = rules.find(r => r.id === ruleId); if(!rule) return;
            document.getElementById('logModalRuleName').innerText = rule.name;
            const logs = automatedRulesHistory.filter(l => l.ruleId === ruleId || l.ruleName === rule.name).sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            document.getElementById('ruleLogsModalBody').innerHTML = logs.length ? logs.map(log => `
                <tr class="border-b border-slate-100 dark:border-slate-800/50">
                    <td class="py-3 pl-6 text-xs text-slate-500 font-mono">${new Date(log.timestamp).toLocaleString('id-ID')}</td>
                    <td class="py-3 text-xs font-bold uppercase text-slate-500 dark:text-slate-400">${log.targetLevel || '-'}</td>
                    <td class="py-3 text-sm font-bold text-slate-700 dark:text-slate-200 truncate max-w-[120px]">${log.assetName}</td>
                    <td class="py-3 text-xs text-slate-600 dark:text-slate-400 font-medium">${log.summary || log.action}</td>
                    <td class="py-3 pr-6 text-center"><span class="px-2 py-1 rounded text-[10px] font-bold ${log.result==='Triggered'||log.result==='Success'?'bg-green-100 text-green-700':'bg-red-100 text-red-700 text-xs'}">${log.result}</span></td>
                </tr>`).join('') : '<tr><td colspan="5" class="text-center py-8 text-slate-400 text-sm">Kosong</td></tr>';
            openRuleLogsModal();
        }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>